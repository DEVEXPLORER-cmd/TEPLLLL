<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <link rel="icon" href="https://placehold.co/32x32/000000/FFFFFF?text=TE" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#000000" />
    <meta
      name="description"
      content="Together Events Supplier Management System Frontend"
    />
    <link rel="apple-touch-icon" href="https://placehold.co/192x192/000000/FFFFFF?text=TE" />
    <link rel="manifest" href="%PUBLIC_URL%/manifest.json" />
    <title>Together Events Supplier System</title>
    <!-- Google Fonts - Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React and ReactDOM CDNs -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel for JSX transformation in browser (for development/demo purposes) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js"></script>
    <style>
      body {
        font-family: 'Inter', sans-serif;
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        background-color: #f3f4f6;
      }
    </style>
</head>
<body>
    <noscript>You need to enable JavaScript to run this app.</noscript>
    <div id="root"></div>

    <script type="text/babel">
        // --- React App Code Starts Here ---

        const { useState, useEffect, createContext, useContext, useCallback } = React;

        // Define your backend URL here
        // IMPORTANT: Change this to your deployed backend URL when deploying your frontend!
        const BACKEND_BASE_URL = 'http://localhost:5000'; // For local development
        // const BACKEND_BASE_URL = 'https://your-deployed-backend.com'; // Uncomment for deployment

        // --- Lucide React Icons re-created as simple SVG for self-contained demo ---
        const ChevronLeft = (props) => (
          <svg xmlns="http://www.w3.org/2000/svg" width={props.size || 24} height={props.size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
            <path d="m15 18-6-6 6-6"/>
          </svg>
        );
        const ChevronRight = (props) => (
          <svg xmlns="http://www.w3.org/2000/svg" width={props.size || 24} height={props.size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
            <path d="m9 18 6-6-6-6"/>
          </svg>
        );
        const UploadCloud = (props) => (
          <svg xmlns="http://www.w3.org/2000/svg" width={props.size || 24} height={props.size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
            <path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242"/>
            <path d="M12 12v9"/>
            <path d="m8 17 4 4 4-4"/>
          </svg>
        );
        const CheckCircle = (props) => (
          <svg xmlns="http://www.w3.org/2000/svg" width={props.size || 24} height={props.size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
            <path d="M22 11.08V12a10 10 0 1 1-5.93-8.16"/>
            <path d="m22 4-7 7-4-4"/>
          </svg>
        );
        const XCircle = (props) => (
          <svg xmlns="http://www.w3.org/2000/svg" width={props.size || 24} height={props.size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
            <circle cx="12" cy="12" r="10"/>
            <path d="m15 9-6 6"/>
            <path d="m9 9 6 6"/>
          </svg>
        );
        const Eye = (props) => (
          <svg xmlns="http://www.w3.org/2000/svg" width={props.size || 24} height={props.size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
            <path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/>
            <circle cx="12" cy="12" r="3"/>
          </svg>
        );
        const Edit = (props) => (
          <svg xmlns="http://www.w3.org/2000/svg" width={props.size || 24} height={props.size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
            <path d="M18.5 2.5a2.121 2 0 0 1 3 3L12 15l-4 1 1-4Z"/>
          </svg>
        );
        const Trash2 = (props) => (
          <svg xmlns="http://www.w3.org/2000/svg" width={props.size || 24} height={props.size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
            <path d="M3 6h18"/>
            <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/>
            <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/>
            <line x1="10" x2="10" y1="11" y2="17"/>
            <line x1="14" x2="14" y1="11" y2="17"/>
          </svg>
        );
        const ArrowUp = (props) => (
          <svg xmlns="http://www.w3.org/2000/svg" width={props.size || 24} height={props.size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
            <path d="m5 12 7-7 7 7"/>
            <path d="M12 19V5"/>
          </svg>
        );
        const ArrowDown = (props) => (
          <svg xmlns="http://www.w3.org/2000/svg" width={props.size || 24} height={props.size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
            <path d="m19 12-7 7-7-7"/>
            <path d="M12 5v14"/>
          </svg>
        );
        const Star = (props) => (
          <svg xmlns="http://www.w3.org/2000/svg" width={props.size || 24} height={props.size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
            <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
          </svg>
        );


        // --- Components ---

        // Modal Component
        const Modal = ({ isOpen, onClose, title, children, type = 'info' }) => {
          if (!isOpen) return null;

          let headerClasses = "text-lg font-semibold text-gray-800";
          let buttonClasses = "px-4 py-2 rounded-md transition-colors duration-200";

          if (type === 'error') {
            headerClasses = "text-lg font-semibold text-red-700";
            buttonClasses = "bg-red-500 hover:bg-red-600 text-white " + buttonClasses;
          } else if (type === 'success') {
            headerClasses = "text-lg font-semibold text-green-700";
            buttonClasses = "bg-green-500 hover:bg-green-600 text-white " + buttonClasses;
          } else if (type === 'confirm') { // New type for confirmation modals
            headerClasses = "text-lg font-semibold text-orange-700";
            buttonClasses = "bg-orange-500 hover:bg-orange-600 text-white " + buttonClasses;
          }
          else { // info or default
            headerClasses = "text-lg font-semibold text-blue-700";
            buttonClasses = "bg-blue-500 hover:bg-blue-600 text-white " + buttonClasses;
          }

          return (
            <div className="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center p-4 z-50">
              <div className="bg-white rounded-xl shadow-xl p-6 w-full max-w-md transform transition-all duration-300 scale-100 opacity-100">
                <div className="flex justify-between items-center mb-4">
                  <h2 className={headerClasses}>{title}</h2>
                  <button
                    onClick={onClose}
                    className="text-gray-500 hover:text-gray-700 text-2xl font-bold leading-none focus:outline-none"
                    aria-label="Close"
                  >
                    &times;
                  </button>
                </div>
                <div className="text-gray-700 mb-6">
                  {children}
                </div>
                {type !== 'confirm' && ( // Only show default close button if not a confirm type
                  <div className="flex justify-end">
                    <button
                      onClick={onClose}
                      className={buttonClasses}
                    >
                      Close
                    </button>
                  </div>
                )}
              </div>
            </div>
          );
        };

        // LoadingSpinner Component
        const LoadingSpinner = ({ message = "Loading..." }) => {
          return (
            <div className="flex flex-col items-center justify-center min-h-[100px] p-4 bg-white rounded-xl shadow-md">
              <div className="animate-spin rounded-full h-8 w-8 border-t-4 border-b-4 border-blue-500"></div>
              <p className="mt-2 text-gray-600 text-sm font-medium">{message}</p>
            </div>
          );
        };

        // --- Firebase Client-Side Initialization (Simplified for Demo) ---
        // In a real React project, this would be in src/utils/firebase.js
        // For this self-contained demo, we'll put it here.
        // NOTE: For Canvas environment, __firebase_config and __initial_auth_token are provided.
        // For local dev, you'd replace 'YOUR_API_KEY' etc. with your actual Firebase config.

        // Mock Firebase functions for demo purposes (if not running in Canvas)
        let firebaseAppInstance;
        let firebaseDbInstance;
        let firebaseAuthInstance;

        const initializeDemoFirebase = () => {
            // Only initialize if window.firebase is not already set up by a real SDK or previous mock
            if (window.firebase && window.firebase.initializeApp) {
                console.log("Mock Firebase: window.firebase already exists, skipping mock initialization.");
                return;
            }

            console.log("Mock Firebase: Initializing mock Firebase.");

            // Mock Firebase app
            firebaseAppInstance = {
                _config: { projectId: 'demo-project' },
                name: 'demo-app',
                options: { projectId: 'demo-project' }
            };

            // Mock Firestore
            const mockFirestoreCollection = (path) => ({
                doc: (docId) => ({
                    collection: (subPath) => mockFirestoreCollection(`${path}/${docId}/${subPath}`)
                }),
                onSnapshot: (callback, errorCallback) => {
                    console.log(`Mock Firestore: Listening to collection ${path}`);
                    // Simulate initial data load
                    const initialData = [
                        { id: 'mock-supplier-1', companyName: 'Demo Events Co.', contactPerson: 'Jane Doe', email: 'jane@demo.com', status: 'Approved', submissionDate: { seconds: Date.now() / 1000 - 86400, nanoseconds: 0 }, panDocument: null, gstDocument: null, msmeDocument: null, cancelledChequeDocument: null, companyProofDocument: null, agreementDocument: null, compliancePolicyDocument: null, ratings: [], averageRating: 0 },
                        { id: 'mock-supplier-2', companyName: 'Sample Services Ltd.', contactPerson: 'John Smith', email: 'john@sample.com', status: 'Pending Review', submissionDate: { seconds: Date.now() / 1000 - 172800, nanoseconds: 0 }, panDocument: {originalname: 'pan.pdf', filepath: '#', status: 'Uploaded', verified: false}, gstDocument: null, msmeDocument: null, cancelledChequeDocument: null, companyProofDocument: null, agreementDocument: null, compliancePolicyDocument: null, ratings: [{score: 4, comment: 'Good work', byUser: 'mock-user-1', date: {seconds: Date.now()/1000 - 100, nanoseconds: 0}}], averageRating: 4 }
                    ];
                    // Simulate a Firestore snapshot structure
                    callback({
                        forEach: (cb) => initialData.forEach(item => cb({ id: item.id, data: () => item })),
                        docChanges: () => initialData.map(item => ({ type: 'added', doc: { id: item.id, data: () => item } }))
                    });
                    // Return an unsubscribe function
                    return () => console.log(`Mock Firestore: Unsubscribed from ${path}`);
                }
            });

            firebaseDbInstance = {
                _app: firebaseAppInstance,
                collection: (db, ...pathSegments) => {
                    // This is a simplified mock for the modular collection function
                    return mockFirestoreCollection(pathSegments.join('/'));
                },
                doc: (db, ...pathSegments) => {
                    // Simplified mock for doc function
                    return {
                        _path: { segments: pathSegments }, // Add _path for mock onSnapshot to work
                        collection: (subPath) => mockFirestoreCollection(pathSegments.join('/') + '/' + subPath)
                    };
                }
            };

            // Mock Auth
            firebaseAuthInstance = {
                _app: firebaseAppInstance,
                currentUser: { uid: 'demo-user-123' }, // Mock current user
                onAuthStateChanged: (callback) => {
                    console.log('Mock Auth: onAuthStateChanged listener set');
                    callback({ uid: 'demo-user-123' }); // Immediately call with a mock user
                    return () => console.log('Mock Auth: onAuthStateChanged listener unsubscribed');
                },
                signInAnonymously: () => {
                    console.log('Mock Auth: signInAnonymously called');
                    return Promise.resolve({ user: { uid: 'anonymous-demo-user' } });
                },
                signInWithCustomToken: (authObj, token) => {
                    console.log('Mock Auth: signInWithCustomToken called');
                    return Promise.resolve({ user: { uid: 'custom-token-demo-user' } });
                }
            };

            // Expose mock firebase globally as window.firebase for the demo's context logic
            // This is crucial for the `AuthContext` to pick it up correctly.
            window.firebase = {
                initializeApp: (config) => {
                    console.log('Mock firebase.initializeApp called');
                    return firebaseAppInstance;
                },
                auth: () => ({
                    getAuth: (app) => {
                        console.log('Mock firebase.auth().getAuth called');
                        return firebaseAuthInstance;
                    }
                }),
                firestore: () => ({
                    getFirestore: (app) => {
                        console.log('Mock firebase.firestore().getFirestore called');
                        return firebaseDbInstance;
                    },
                    // Expose modular functions directly onto window for React components to use
                    // This simulates `import { collection, onSnapshot, doc, updateDoc, deleteDoc } from 'firebase/firestore';`
                    // in a single-file Babel environment.
                    collection: (db, ...pathSegments) => firebaseDbInstance.collection(db, ...pathSegments),
                    onSnapshot: (query, callback, errorCallback) => {
                        // This mock needs to correctly handle query objects
                        // For simplicity, assuming query is a collection reference here
                        if (query._path && query._path.segments) {
                            return mockFirestoreCollection(query._path.segments.join('/')).onSnapshot(callback, errorCallback);
                        }
                        console.error("Mock onSnapshot received an unexpected query object:", query);
                        return () => {}; // Return a no-op unsubscribe
                    },
                    doc: (db, ...pathSegments) => firebaseDbInstance.doc(db, ...pathSegments),
                    updateDoc: async (docRef, data) => {
                        console.log(`Mock Firestore: updateDoc called for ${docRef._path.segments.join('/')} with data:`, data);
                        // In a real mock, you'd update an in-memory representation
                        return Promise.resolve();
                    },
                    deleteDoc: async (docRef) => {
                        console.log(`Mock Firestore: deleteDoc called for ${docRef._path.segments.join('/')}`);
                        // In a real mock, you'd remove from in-memory representation
                        return Promise.resolve();
                    }
                })
            };
        };

        // Call mock initialization if not in a real Firebase environment
        // This needs to be called *before* any React components try to use Firebase.
        // It's safer to call it here to ensure window.firebase is populated for the AuthProvider.
        if (typeof window !== 'undefined' && !window.firebase) { // Check if window.firebase is not already defined
            initializeDemoFirebase();
        }


        // Auth Context
        const AuthContext = createContext();

        const useAuth = () => {
          return useContext(AuthContext);
        };

        const AuthProvider = ({ children }) => {
          const [userId, setUserId] = useState(null);
          const [isAuthReady, setIsAuthReady] = useState(false);
          const [dbInstance, setDbInstance] = useState(null);
          const [authInstance, setAuthInstance] = useState(null);

          useEffect(() => {
            let timeoutId;

            const checkFirebaseReady = async () => {
              console.log("Checking if Firebase is ready...");
              if (typeof window !== 'undefined' && window.firebase && window.firebase.initializeApp &&
                  window.firebase.auth && window.firebase.firestore &&
                  window.firebase.auth().getAuth && window.firebase.firestore().getFirestore) {
                console.log("Firebase and core modules are available. Initializing...");

                let app, auth, db;

                // Determine if running in Canvas environment
                if (typeof window.__firebase_config !== 'undefined') {
                  console.log("Canvas environment detected, using __firebase_config.");
                  const firebaseConfig = JSON.parse(window.__firebase_config);
                  app = window.firebase.initializeApp(firebaseConfig);
                  auth = window.firebase.auth().getAuth(app);
                  db = window.firebase.firestore().getFirestore(app);
                } else {
                  console.log("Non-Canvas environment, using mock or local Firebase setup.");
                  // Fallback for local development/non-Canvas environment (using mock or local setup)
                  app = window.firebase.initializeApp(); // Call initializeApp on the global mock
                  auth = window.firebase.auth().getAuth(app);
                  db = window.firebase.firestore().getFirestore(app);
                }

                setAuthInstance(auth);
                setDbInstance(db);
                console.log("Firebase app, auth, and db instances set.");

                const unsubscribe = auth.onAuthStateChanged(async (user) => {
                  console.log("Auth state changed. User:", user);
                  if (user) {
                    setUserId(user.uid);
                  } else {
                    console.log("No user found, attempting sign-in.");
                    if (typeof window.__initial_auth_token !== 'undefined') {
                      try {
                        console.log("Attempting signInWithCustomToken...");
                        await auth.signInWithCustomToken(auth, window.__initial_auth_token);
                        setUserId(auth.currentUser?.uid || 'anonymous-user');
                        console.log("Signed in with custom token. User ID:", auth.currentUser?.uid);
                      } catch (error) {
                        console.error("Error signing in with custom token:", error);
                        console.log("Falling back to anonymous sign-in...");
                        await auth.signInAnonymously();
                        setUserId(auth.currentUser?.uid || 'anonymous-user');
                        console.log("Signed in anonymously. User ID:", auth.currentUser?.uid);
                      }
                    } else {
                      console.log("No custom token, attempting anonymous sign-in...");
                      await auth.signInAnonymously();
                      setUserId(auth.currentUser?.uid || 'anonymous-user');
                      console.log("Signed in anonymously. User ID:", auth.currentUser?.uid);
                    }
                  }
                  setIsAuthReady(true);
                  console.log("Auth is ready.");
                });
                return unsubscribe;
              } else {
                console.log("Firebase not yet ready, retrying in 50ms...");
                timeoutId = setTimeout(checkFirebaseReady, 50); // Retry after 50ms
              }
            };

            // Start the initial check with a small delay
            timeoutId = setTimeout(checkFirebaseReady, 50);

            return () => {
              if (timeoutId) {
                clearTimeout(timeoutId);
              }
              // Cleanup for onAuthStateChanged listener will be handled by its return value
            };
          }, []); // Empty dependency array means this effect runs once on mount

          const value = { userId, isAuthReady, db: dbInstance, auth: authInstance };

          return (
            <AuthContext.Provider value={value}>
              {children}
            </AuthContext.Provider>
          );
        };

        // --- Static Data for Validation and Dropdowns ---

        const countryPhonePatterns = {
            "IN": { pattern: /^[6-9]\d{9}$/, example: "e.g., 9876543210 (10 digits)" }, // Indian mobile numbers
            "US": { pattern: /^\(?([0-9]{3})\)?[-. ]?([0-9]{3})[-. ]?([0-9]{4})$/, example: "e.g., (123) 456-7890 (10 digits)" },
            "GB": { pattern: /^(\+44\s?7\d{3}|\(?07\d{3}\)?)\s?\d{6}$/, example: "e.g., +447911123456 or 07911123456 (10-11 digits)" },
            "CA": { pattern: /^\(?([0-9]{3})\)?[-. ]?([0-9]{3})[-. ]?([0-9]{4})$/, example: "e.g., (123) 456-7890 (10 digits)" },
            "AU": { pattern: /^(\(0[1-9]\)|0[1-9])?\d{8}$/, example: "e.g., 0412345678 (9-10 digits)" },
            // Generic pattern for other countries (basic digits and optional +)
            "Other": { pattern: /^\+?[0-9\s-()]{7,20}$/, example: "e.g., +123 456 7890 (7-20 digits)" }
        };

        const indianStatesAndCities = {
            "Andhra Pradesh": {
                cities: ["Visakhapatnam", "Vijayawada", "Guntur", "Nellore", "Kurnool", "Rajahmundry", "Kakinada", "Tirupati", "Eluru", "Ongole"],
                pincodePrefixes: ["51", "52", "53"]
            },
            "Arunachal Pradesh": {
                cities: ["Itanagar", "Naharlagun", "Tawang", "Bomdila", "Pasighat"],
                pincodePrefixes: ["79"]
            },
            "Assam": {
                cities: ["Guwahati", "Jorhat", "Dibrugarh", "Silchar", "Tezpur", "Nagaon", "Bongaigaon"],
                pincodePrefixes: ["78"]
            },
            "Bihar": {
                cities: ["Patna", "Gaya", "Bhagalpur", "Muzaffarpur", "Darbhanga", "Arrah", "Purnia", "Bihar Sharif"],
                pincodePrefixes: ["80", "81", "82", "84", "85"]
            },
            "Chhattisgarh": {
                cities: ["Raipur", "Bhilai", "Bilaspur", "Korba", "Durg", "Ambikapur"],
                pincodePrefixes: ["49"]
            },
            "Goa": {
                cities: ["Panaji", "Margao", "Vasco da Gama", "Mapusa", "Ponda"],
                pincodePrefixes: ["403"]
            },
            "Gujarat": {
                cities: ["Ahmedabad", "Surat", "Vadodara", "Rajkot", "Bhavnagar", "Jamnagar", "Gandhinagar", "Junagadh", "Anand"],
                pincodePrefixes: ["36", "37", "38", "39"]
            },
            "Haryana": {
                cities: ["Faridabad", "Gurugram", "Panipat", "Ambala", "Hisar", "Rohtak", "Karnal", "Sonipat", "Panchkula", "Sirsa", "Yamunanagar"],
                pincodePrefixes: ["12", "13"]
            },
            "Himachal Pradesh": {
                cities: ["Shimla", "Mandi", "Dharamshala", "Solan", "Kullu", "Manali"],
                pincodePrefixes: ["17"]
            },
            "Jharkhand": {
                cities: ["Ranchi", "Jamshedpur", "Dhanbad", "Bokaro", "Hazaribagh", "Deoghar", "Phusro"],
                pincodePrefixes: ["82", "83"]
            },
            "Karnataka": {
                cities: ["Bengaluru", "Mysuru", "Hubballi", "Mangaluru", "Belagavi", "Davanagere", "Ballari", "Tumakuru", "Shivamogga"],
                pincodePrefixes: ["56", "57", "58"]
            },
            "Kerala": {
                cities: ["Thiruvananthapuram", "Kochi", "Kozhikode", "Thrissur", "Kollam", "Palakkad", "Alappuzha", "Kannur"],
                pincodePrefixes: ["67", "68", "69"]
            },
            "Madhya Pradesh": {
                cities: ["Bhopal", "Indore", "Jabalpur", "Gwalior", "Ujjain", "Sagar", "Dewas", "Satna", "Ratlam"],
                pincodePrefixes: ["45", "46", "47", "48"]
            },
            "Maharashtra": {
                cities: ["Mumbai", "Pune", "Nagpur", "Nashik", "Aurangabad", "Thane", "Solapur", "Kolhapur", "Amravati", "Nanded", "Sangli"],
                pincodePrefixes: ["40", "41", "42", "43", "44"]
            },
            "Manipur": {
                cities: ["Imphal", "Thoubal", "Churachandpur"],
                pincodePrefixes: ["795"]
            },
            "Meghalaya": {
                cities: ["Shillong", "Tura", "Jowai"],
                pincodePrefixes: ["793"]
            },
            "Mizoram": {
                cities: ["Aizawl", "Lunglei", "Champhai"],
                pincodePrefixes: ["796"]
            },
            "Nagaland": {
                cities: ["Kohima", "Dimapur", "Mokokchung"],
                pincodePrefixes: ["797"]
            },
            "Odisha": {
                cities: ["Bhubaneswar", "Cuttack", "Rourkela", "Berhampur", "Sambalpur", "Puri", "Balasore"],
                pincodePrefixes: ["75", "76"]
            },
            "Punjab": {
                cities: ["Ludhiana", "Amritsar", "Jalandhar", "Patiala", "Panchkula", "Mohali", "Bathinda", "Hoshiarpur", "Moga", "Abohar"],
                pincodePrefixes: ["14", "15", "16"]
            },
            "Rajasthan": {
                cities: ["Jaipur", "Jodhpur", "Udaipur", "Kota", "Ajmer", "Bikaner", "Alwar", "Bhilwara", "Sikar"],
                pincodePrefixes: ["30", "31", "32", "33", "34"]
            },
            "Sikkim": {
                cities: ["Gangtok", "Namchi", "Geyzing", "Mangan"],
                pincodePrefixes: ["737"]
            },
            "Tamil Nadu": {
                cities: ["Chennai", "Coimbatore", "Madurai", "Tiruchirappalli", "Salem", "Tirunelveli", "Vellore", "Erode", "Thoothukudi"],
                pincodePrefixes: ["60", "61", "62", "63", "64"]
            },
            "Telangana": {
                cities: ["Hyderabad", "Warangal", "Nizamabad", "Khammam", "Karimnagar", "Ramagundam"],
                pincodePrefixes: ["50"]
            },
            "Tripura": {
                cities: ["Agartala", "Udaipur", "Dharmanagar"],
                pincodePrefixes: ["799"]
            },
            "Uttar Pradesh": {
                cities: ["Lucknow", "Kanpur", "Ghaziabad", "Agra", "Varanasi", "Meerut", "Prayagraj", "Bareilly", "Aligarh", "Moradabad", "Saharanpur", "Gorakhpur", "Noida", "Greater Noida"],
                pincodePrefixes: ["20", "21", "22", "23", "24", "25", "26", "27", "28"]
            },
            "Uttarakhand": {
                cities: ["Dehradun", "Haridwar", "Roorkee", "Haldwani", "Rishikesh", "Nainital"],
                pincodePrefixes: ["24"]
            },
            "West Bengal": {
                cities: ["Kolkata", "Howrah", "Durgapur", "Asansol", "Siliguri", "Bardhaman", "Malda", "Kharagpur", "Haldia"],
                pincodePrefixes: ["70", "71", "72", "73", "74"]
            },
            "Andaman and Nicobar Islands": {
                cities: ["Port Blair"],
                pincodePrefixes: ["744"]
            },
            "Chandigarh": {
                cities: ["Chandigarh"],
                pincodePrefixes: ["160"]
            },
            "Dadra and Nagar Haveli and Daman and Diu": {
                cities: ["Daman", "Silvassa", "Diu"],
                pincodePrefixes: ["396", "362"]
            },
            "Lakshadweep": {
                cities: ["Kavaratti"],
                pincodePrefixes: ["682"]
            },
            "Delhi": {
                cities: ["New Delhi", "Delhi"],
                pincodePrefixes: ["110"]
            },
            "Puducherry": {
                cities: ["Puducherry", "Karaikal", "Mahe", "Yanam"],
                pincodePrefixes: ["605", "609", "673", "533"]
            },
            "Ladakh": {
                cities: ["Leh", "Kargil"],
                pincodePrefixes: ["194"]
            },
            "Jammu and Kashmir": {
                cities: ["Srinagar", "Jammu", "Anantnag", "Baramulla"],
                pincodePrefixes: ["190", "180", "192"]
            }
        };

        const indianBankNames = [
            "State Bank of India", "Punjab National Bank", "Bank of Baroda", "Canara Bank",
            "Union Bank of India", "Bank of India", "Indian Bank", "Central Bank of India",
            "Indian Overseas Bank", "UCO Bank", "Axis Bank", "HDFC Bank", "ICICI Bank",
            "IndusInd Bank", "Kotak Mahindra Bank", "Yes Bank", "IDFC First Bank",
            "Federal Bank", "RBL Bank", "Bandhan Bank", "AU Small Finance Bank",
            "Equitas Small Finance Bank", "Jana Small Finance Bank", "Utkarsh Small Finance Bank",
            "Fincare Small Finance Bank", "Suryoday Small Finance Bank", "Ujjivan Small Finance Bank",
            "ESAF Small Finance Bank", "North East Small Finance Bank", "Payment Banks (Airtel, Paytm, India Post)",
            "Standard Chartered Bank", "HSBC Bank", "Citibank", "Deutsche Bank", "DBS Bank India"
        ];

        const suitableForOptions = [
            "Small Businesses", "Medium Businesses", "Large Enterprises",
            "Startups", "Non-Profits", "Government Agencies", "Individual Clients"
        ];

        const serviceCategories = {
            "Event Management": ["Corporate Events", "Weddings & Social Events", "Conferences & Exhibitions", "Product Launches", "Virtual Events"],
            "Catering Services": ["Full-Service Catering", "Buffet Catering", "Boxed Meals", "Beverage Services"],
            "Venue Rental": ["Conference Rooms", "Banquet Halls", "Outdoor Spaces", "Unique Venues"],
            "Audio/Visual Production": ["Sound Systems", "Lighting Design", "LED Walls", "Live Streaming"],
            "Photography & Videography": ["Event Photography", "Event Videography", "Photo Booths", "Post-Production"],
            "Decor & Styling": ["Floral Arrangements", "Theme Decor", "Furniture Rental", "Stage Design"],
            "Staffing Solutions": ["Event Staff", "Security Personnel", "Hospitality Staff", "Technical Support"],
            "Marketing & Promotion": ["Digital Marketing", "Print Collateral", "Social Media Management", "PR Services"],
            "Logistics & Transportation": ["Guest Transportation", "Equipment Transport", "Warehousing", "Customs Clearance"],
            "Entertainment": ["Live Music", "DJs", "Performers (Magicians, Dancers, etc.)", "Speakers/MCs"],
            "Technology Solutions": ["Event Apps", "Registration Platforms", "Interactive Displays", "Cybersecurity for Events"],
            "Consulting": ["Event Planning Consulting", "Strategy Consulting", "Risk Management Consulting"]
        };


        // Validation Rules (for real-time feedback)
        const validationRules = {
          companyName: (value) => value.trim() !== '',
          contactPerson: (value) => value.trim() !== '',
          email: (value) => /\S+@\S+\.\S+/.test(value),
          phone: (value, formData) => {
              const countryPattern = countryPhonePatterns[formData.countryCode]?.pattern || countryPhonePatterns.Other.pattern;
              return countryPattern.test(value);
          },
          address: (value) => value.trim().length >= 10, // Enforce minimum length for a detailed address
          countryCode: (value) => value.trim() !== '', // Ensure a country is selected
          state: (value, formData) => {
              if (formData.countryCode === 'IN') {
                  // State must be in the predefined list for India
                  return Object.keys(indianStatesAndCities).includes(value);
              }
              return value.trim() !== ''; // Required for non-Indian countries too
          },
          city: (value, formData) => {
              if (formData.countryCode === 'IN' && formData.state && indianStatesAndCities[formData.state]) {
                  // If state is selected and valid, check if city is in that state's list
                  // Allow empty if not required, but if provided, it must be valid for the state
                  return value.trim() === '' || indianStatesAndCities[formData.state].cities.includes(value);
              }
              return value.trim() !== ''; // Required for non-Indian countries too
          },
          pincode: (value, formData) => {
              // Pincode must be 6 digits
              if (!/^\d{6}$/.test(value)) {
                  return false;
              }
              // If India is selected and a state is entered, validate against state's pincode prefixes
              if (formData.countryCode === 'IN' && formData.state) {
                  const stateData = indianStatesAndCities[formData.state];
                  if (stateData && stateData.pincodePrefixes) {
                      return stateData.pincodePrefixes.some(prefix => value.startsWith(prefix));
                  }
              }
              // For other countries or if state data is missing, just check for 6 digits
              return true;
          },
          legalEntityType: (value) => value !== '',
          otherLegalEntityType: (value, formData) => formData.legalEntityType === 'Other' ? value.trim() !== '' : true,
          pan: (value) => /^[A-Z]{5}[0-9]{4}[A-Z]{1}$/.test(value),
          gstin: (value) => { // GSTIN is now always optional
              return value.trim() === '' || /^[0-9]{2}[A-Z]{5}[0-9]{4}[A-Z]{1}[1-9A-Z]{1}Z[0-9A-Z]{1}$/.test(value);
          },
          bankName: (value) => indianBankNames.some(bank => bank.toLowerCase() === value.toLowerCase()),
          accountNumber: (value) => /^\d{9,18}$/.test(value), // Common Indian account number length
          ifscCode: (value) => /^[A-Z]{4}0[A-Z0-9]{6}$/.test(value),
          suitableFor: (value) => value.trim() !== '', // New: Suitable For
          serviceCategory: (value) => value.trim() !== '', // New: Service Category
          serviceSubcategory: (value) => value.trim() !== '', // New: Service Subcategory
          yearsInBusiness: (value) => value > 0,
          agreeToCodeOfConduct: (value) => value === true,
          agreeToDataSecurity: (value) => value === true,
          subcontractorVettingProcess: (value, formData) => formData.subcontractorApprovalRequired === 'Yes' ? value.trim() !== '' : true,
          preventWorkIrregularities: (value) => value === true,
          ipAssignment: (value) => value === true,
          // Documents validation - now individual fields
          panDocument: (value) => value !== null,
          gstDocument: (value) => value !== null,
          msmeDocument: (value, formData) => formData.isMsmeRegistered ? (value !== null) : true, // MSME doc required only if registered
          cancelledChequeDocument: (value) => value !== null,
          companyProofDocument: (value) => value !== null,
          agreementDocument: (value) => value !== null,
          compliancePolicyDocument: (value) => value !== null,
          isMsmeRegistered: (value) => typeof value === 'boolean', // Ensure it's a boolean
          hasPriorRelationship: (value) => typeof value === 'boolean' // New validation for prior relationship
        };

        // Helper to get validation icon
        const getValidationIcon = (fieldName, formData, errors) => {
          if (errors[fieldName]) {
            return <XCircle size={16} className="text-red-500 absolute right-3 top-1/2 -translate-y-1/2" />;
          }
          // Only show checkmark if field is not empty and passes its specific rule
          // Special handling for checkboxes and file inputs (which are boolean/object)
          if (['agreeToCodeOfConduct', 'agreeToDataSecurity', 'preventWorkIrregularities', 'ipAssignment', 'isMsmeRegistered', 'hasPriorRelationship',
               'panDocument', 'gstDocument', 'msmeDocument', 'cancelledChequeDocument', 'companyProofDocument', 'agreementDocument', 'compliancePolicyDocument'].includes(fieldName)) {
              if (formData[fieldName] === true || (formData[fieldName] !== null && typeof formData[fieldName] === 'object')) {
                  return <CheckCircle size={16} className="text-green-500 absolute right-3 top-1/2 -translate-y-1/2" />;
              }
              return null;
          }
          // For other fields, check if not empty and passes rule
          if (formData[fieldName] !== '' && validationRules[fieldName] && validationRules[fieldName](formData[fieldName], formData)) {
            return <CheckCircle size={16} className="text-green-500 absolute right-3 top-1/2 -translate-y-1/2" />;
          }
          return null;
        };

        // Helper to get validation border class
        const getValidationBorderClass = (fieldName, errors) => {
          return errors[fieldName] ? 'border-red-500' : 'border-gray-300';
        };

        // DocumentUploadField Component (reusable for individual documents)
        const DocumentUploadField = ({ label, name, file, onFileChange, onRemoveFile, error, isRequired = true }) => {
            const [isDragging, setIsDragging] = useState(false);

            const handleDragOver = (e) => { e.preventDefault(); setIsDragging(true); };
            const handleDragLeave = (e) => { e.preventDefault(); setIsDragging(false); };
            const handleDrop = (e) => {
                e.preventDefault();
                setIsDragging(false);
                const droppedFile = e.dataTransfer.files[0];
                if (droppedFile) {
                    onFileChange({ target: { files: [droppedFile] } });
                }
            };

            return (
                <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                        {label} {isRequired && <span className="text-red-500">*</span>}
                    </label>
                    <div
                        className={`mt-1 flex justify-center px-6 pt-5 pb-6 border-2 ${isDragging ? 'border-blue-500 bg-blue-50' : error ? 'border-red-500' : 'border-gray-300'} border-dashed rounded-md transition-all duration-200`}
                        onDragOver={handleDragOver}
                        onDragLeave={handleDragLeave}
                        onDrop={handleDrop}
                    >
                        <div className="space-y-1 text-center">
                            <UploadCloud className="mx-auto h-12 w-12 text-gray-400" />
                            <div className="flex text-sm text-gray-600">
                                <label htmlFor={name} className="relative cursor-pointer bg-white rounded-md font-medium text-blue-600 hover:text-blue-500 focus-within:outline-none focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-blue-500">
                                    <span>Upload file</span>
                                    <input id={name} name={name} type="file" className="sr-only" onChange={onFileChange} accept=".pdf,.png,.jpg,.jpeg" />
                                </label>
                                <p className="pl-1">or drag and drop</p>
                            </div>
                            <p className="text-xs text-gray-500">PDF, PNG, JPG up to 10MB</p>
                        </div>
                    </div>
                    {error && <p className="text-red-500 text-xs mt-1">{error}</p>}
                    {file && (
                        <div className="mt-4">
                            <ul className="divide-y divide-gray-200 rounded-md border border-gray-200">
                                <li className="flex items-center justify-between py-3 pl-3 pr-4 text-sm">
                                    <div className="flex w-0 flex-1 items-center">
                                        <CheckCircle className="h-5 w-5 text-green-500" aria-hidden="true" />
                                        <span className="ml-2 w-0 flex-1 truncate">{file.name || file.originalname}</span>
                                    </div>
                                    <div className="ml-4 flex-shrink-0">
                                        <button
                                            type="button"
                                            onClick={onRemoveFile}
                                            className="font-medium text-red-600 hover:text-red-500"
                                        >
                                            Remove
                                        </button>
                                    </div>
                                </li>
                            </ul>
                        </div>
                    )}
                </div>
            );
        };


        // SupplierOnboardingForm Component
        const SupplierOnboardingForm = ({ onSubmitSuccess }) => {
          const [currentStep, setCurrentStep] = useState(1);
          const [formData, setFormData] = useState({
            companyName: '', contactPerson: '', email: '', phone: '', address: '', city: '', state: '', pincode: '', countryCode: 'IN', // Default to India
            legalEntityType: '', otherLegalEntityType: '', pan: '', gstin: '', bankName: '', accountNumber: '', ifscCode: '',
            isMsmeRegistered: false, // New MSME field
            hasPriorRelationship: false, // New prior relationship field
            suitableFor: '', // New field
            serviceCategory: '', // New field
            serviceSubcategory: '', // New field
            yearsInBusiness: '', references: '',
            agreeToCodeOfConduct: false, agreeToDataSecurity: false,
            subcontractorApprovalRequired: 'No', subcontractorVettingProcess: '', preventWorkIrregularities: false,
            ipAssignment: false,
            // New document fields
            panDocument: null,
            gstDocument: null,
            msmeDocument: null,
            cancelledChequeDocument: null,
            companyProofDocument: null,
            agreementDocument: null,
            compliancePolicyDocument: null,
          });
          const [errors, setErrors] = useState({});
          const [isSubmitting, setIsSubmitting] = useState(false);
          const [modalOpen, setModalOpen] = useState(false);
          const [modalContent, setModalContent] = useState({ title: '', message: '', type: 'info' });

          const totalSteps = 6; // Basic, Legal/Financial, Operational, Compliance, Subcontractor, Documents/Declaration

          const handleChange = (e) => {
            const { name, value, type, checked } = e.target;
            let newValue = type === 'checkbox' ? checked : value;

            // Special handling for radio buttons to convert string "true"/"false" to boolean
            if (name === 'isMsmeRegistered' || name === 'hasPriorRelationship') {
                newValue = value === 'true';
                // If MSME is set to No, clear the MSME document and its error
                if (name === 'isMsmeRegistered' && !newValue) {
                    setFormData(prev => ({ ...prev, msmeDocument: null }));
                    setErrors(prevErrors => {
                        const newErrors = { ...prevErrors };
                        delete newErrors.msmeDocument;
                        return newErrors;
                    });
                }
            }


            setFormData(prev => {
              const updatedFormData = { ...prev, [name]: newValue };

              // Special handling for countryCode change to reset state/city
              if (name === 'countryCode') {
                  updatedFormData.state = '';
                  updatedFormData.city = '';
                  // Clear state/city errors if country changes
                  setErrors(prevErrors => {
                      const newErrors = { ...prevErrors };
                      delete newErrors.state;
                      delete newErrors.city;
                      delete newErrors.pincode; // Also clear pincode error
                      return newErrors;
                  });
              }
              // Special handling for state change to clear city and pincode
              if (name === 'state' && updatedFormData.countryCode === 'IN') {
                  updatedFormData.city = '';
                  updatedFormData.pincode = ''; // Clear pincode on state change
                  setErrors(prevErrors => {
                      const newErrors = { ...prevErrors };
                      delete newErrors.city;
                      delete newErrors.pincode; // Clear pincode error
                      return newErrors;
                  });
              }
              // Special handling for legalEntityType change to clear GSTIN error if it becomes optional
              // This entire block is now effectively redundant for GSTIN as it's always optional,
              // but keeping it for other potential future conditional logic.
              if (name === 'legalEntityType') {
                  if (errors.gstin && validationRules.gstin(updatedFormData.gstin)) {
                      setErrors(prevErrors => {
                          const newErrors = { ...prevErrors };
                          delete newErrors.gstin;
                          return newErrors;
                      });
                  }
              }

              // Special handling for serviceCategory change to reset subcategory
              if (name === 'serviceCategory') {
                updatedFormData.serviceSubcategory = ''; // Reset subcategory when category changes
                setErrors(prevErrors => {
                    const newErrors = { ...prevErrors };
                    delete newErrors.serviceSubcategory;
                    return newErrors;
                });
              }


              // Re-validate the field immediately
              const fieldIsValid = validationRules[name] ? validationRules[name](newValue, updatedFormData) : true;
              setErrors(prevErrors => {
                const newErrors = { ...prevErrors };
                if (!fieldIsValid) {
                  // Specific error message for address
                  if (name === 'address') {
                    newErrors[name] = 'Please enter a detailed address (minimum 10 characters).';
                  } else if (name === 'gstin') {
                    // GSTIN is optional, but if provided, it must be valid.
                    // Only show error if value is not empty and validation fails.
                    if (newValue.trim() !== '') {
                        newErrors[name] = 'GSTIN is invalid.';
                    } else {
                        delete newErrors[name]; // Clear error if it's empty and optional
                    }
                  } else if (name === 'msmeDocument' && updatedFormData.isMsmeRegistered) {
                      newErrors[name] = 'MSME document is required if registered.';
                  } else if (['panDocument', 'gstDocument', 'cancelledChequeDocument', 'companyProofDocument', 'agreementDocument', 'compliancePolicyDocument'].includes(name)) {
                      newErrors[name] = `${labelMap[name]} is required.`;
                  }
                  else {
                    newErrors[name] = `${name} is invalid or required.`; // Generic message for demo
                  }
                } else {
                  delete newErrors[name];
                }
                return newErrors;
              });
              return updatedFormData;
            });
          };

          // Generic file handler for individual document fields
          const handleDocumentFileChange = (fieldName) => (e) => {
            const file = e.target.files[0];
            setFormData(prev => ({ ...prev, [fieldName]: file }));
            setErrors(prev => {
                const newErrors = { ...prev };
                delete newErrors[fieldName];
                return newErrors;
            });
          };

          const removeDocumentFile = (fieldName) => () => {
            setFormData(prev => ({ ...prev, [fieldName]: null }));
            // Re-add error if it's a required field and now null
            if (validationRules[fieldName] && !validationRules[fieldName](null, formData)) {
                setErrors(prev => ({ ...prev, [fieldName]: `${labelMap[fieldName]} is required.` }));
            }
          };

          // Mapping for display labels for document fields
          const labelMap = {
              panDocument: 'PAN Document',
              gstDocument: 'GST Document',
              msmeDocument: 'MSME Document',
              cancelledChequeDocument: 'Cancelled Cheque',
              companyProofDocument: 'Company Proof',
              agreementDocument: 'Agreement',
              compliancePolicyDocument: 'Compliance Policy'
          };


          const validateStep = () => {
            let newErrors = {};
            let isValid = true;

            // Validate all fields for the current step
            const fieldsToValidate = {
              1: ['companyName', 'contactPerson', 'email', 'phone', 'countryCode', 'state', 'city', 'pincode', 'address'], // Reordered fields
              2: ['legalEntityType', 'otherLegalEntityType', 'pan', 'gstin', 'bankName', 'accountNumber', 'ifscCode', 'isMsmeRegistered', 'hasPriorRelationship'],
              3: ['suitableFor', 'serviceCategory', 'serviceSubcategory', 'yearsInBusiness'], // Updated fields for step 3
              4: ['agreeToCodeOfConduct', 'agreeToDataSecurity'],
              5: ['subcontractorApprovalRequired', 'subcontractorVettingProcess', 'preventWorkIrregularities'],
              6: ['panDocument', 'gstDocument', 'msmeDocument', 'cancelledChequeDocument', 'companyProofDocument', 'agreementDocument', 'compliancePolicyDocument', 'ipAssignment']
            };

            fieldsToValidate[currentStep].forEach(field => {
              let fieldValue = formData[field];

              if (validationRules[field] && !validationRules[field](fieldValue, formData)) {
                // Specific error message for address during step validation
                if (field === 'address') {
                  newErrors[field] = 'Please enter a detailed address (minimum 10 characters).';
                } else if (field === 'gstin') {
                    // GSTIN is optional, but if provided, it must be valid.
                    // Only show error if value is not empty and validation fails.
                    if (formData.gstin.trim() !== '') {
                        newErrors[field] = 'GSTIN is invalid.';
                        isValid = false;
                    }
                } else if (['panDocument', 'gstDocument', 'msmeDocument', 'cancelledChequeDocument', 'companyProofDocument', 'agreementDocument', 'compliancePolicyDocument'].includes(field)) {
                    // For mandatory documents, if missing
                    if (field === 'msmeDocument' && !formData.isMsmeRegistered) {
                        // MSME document is only required if isMsmeRegistered is true
                        // So, if isMsmeRegistered is false, and msmeDocument is null, it's valid.
                        // No error should be added here.
                    } else {
                        newErrors[field] = `${labelMap[field]} is required.`;
                        isValid = false;
                    }
                }
                else {
                  newErrors[field] = `${field} is invalid or required.`; // Generic message
                  isValid = false;
                }
              }
            });

            setErrors(newErrors);
            return isValid;
          };

          const nextStep = () => {
            if (validateStep()) {
              setCurrentStep(prev => Math.min(prev + 1, totalSteps));
            } else {
              setModalContent({
                title: 'Validation Error',
                message: 'Please fill in all required fields and correct errors before proceeding.',
                type: 'error'
              });
              setModalOpen(true);
            }
          };

          const prevStep = () => {
            setCurrentStep(prev => Math.max(prev - 1, 1));
          };

          const handleSubmit = async (e) => {
            e.preventDefault();
            if (!validateStep()) {
              setModalContent({
                title: 'Validation Error',
                message: 'Please fill in all required fields and correct errors before submitting.',
                type: 'error'
              });
              setModalOpen(true);
              return;
            }

            setIsSubmitting(true);
            const formPayload = new FormData();

            // Append all form data fields (excluding the file objects themselves, which are handled below)
            for (const key in formData) {
                if (formData[key] instanceof File || formData[key] === null) {
                    // Skip file objects here, they are appended specifically below
                    continue;
                }
                formPayload.append(key, formData[key]);
            }

            // Append individual document files
            if (formData.panDocument) formPayload.append('panDocument', formData.panDocument);
            if (formData.gstDocument) formPayload.append('gstDocument', formData.gstDocument);
            if (formData.msmeDocument) formPayload.append('msmeDocument', formData.msmeDocument);
            if (formData.cancelledChequeDocument) formPayload.append('cancelledChequeDocument', formData.cancelledChequeDocument);
            if (formData.companyProofDocument) formPayload.append('companyProofDocument', formData.companyProofDocument);
            if (formData.agreementDocument) formPayload.append('agreementDocument', formData.agreementDocument);
            if (formData.compliancePolicyDocument) formPayload.append('compliancePolicyDocument', formData.compliancePolicyDocument);


            try {
              const response = await fetch(`${BACKEND_BASE_URL}/api/suppliers`, {
                method: 'POST',
                body: formPayload, // Multer handles multipart/form-data
              });

              if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || 'Failed to submit form');
              }

              const result = await response.json();
              setModalContent({
                title: 'Submission Successful!',
                message: `Your supplier onboarding form has been submitted successfully! Reference ID: ${result.id}.`,
                type: 'success'
              });
              setModalOpen(true);
              setFormData({ // Reset form after successful submission
                companyName: '', contactPerson: '', email: '', phone: '', address: '', city: '', state: '', pincode: '', countryCode: 'IN',
                legalEntityType: '', otherLegalEntityType: '', pan: '', gstin: '', bankName: '', accountNumber: '', ifscCode: '',
                isMsmeRegistered: false, // Reset MSME field
                hasPriorRelationship: false, // Reset prior relationship field
                suitableFor: '', // Reset suitableFor
                serviceCategory: '', // Reset serviceCategory
                serviceSubcategory: '', // Reset serviceSubcategory
                yearsInBusiness: '', references: '',
                agreeToCodeOfConduct: false, agreeToDataSecurity: false,
                subcontractorApprovalRequired: 'No', subcontractorVettingProcess: '', preventWorkIrregularities: false,
                ipAssignment: false,
                panDocument: null,
                gstDocument: null,
                msmeDocument: null,
                cancelledChequeDocument: null,
                companyProofDocument: null,
                agreementDocument: null,
                compliancePolicyDocument: null,
              });
              setCurrentStep(1);
              if (onSubmitSuccess) onSubmitSuccess(); // Notify parent component
            } catch (error) {
              setModalContent({
                title: 'Submission Failed',
                message: `There was an error submitting your form: ${error.message}. Please ensure your backend is running and configured correctly.`,
                type: 'error'
              });
              setModalOpen(true);
              console.error('Submission error:', error);
            } finally {
              setIsSubmitting(false);
            }
          };

          const renderStepContent = () => {
            const phonePlaceholder = countryPhonePatterns[formData.countryCode]?.example || countryPhonePatterns.Other.example;
            // Ensure indianStatesAndCities[formData.state] is an object and has a 'cities' array before accessing
            const currentCities = (formData.countryCode === 'IN' && indianStatesAndCities[formData.state]?.cities)
                                  ? indianStatesAndCities[formData.state].cities
                                  : [];

            // Get subcategories for the currently selected category
            const currentSubcategories = serviceCategories[formData.serviceCategory] || [];

            return (
              <>
                {currentStep === 1 && (
                  <>
                    <h3 className="text-xl font-semibold text-gray-800 mb-6">Basic Company & Contact Information</h3>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                      <div className="relative">
                        <label htmlFor="companyName" className="block text-sm font-medium text-gray-700">Company Name <span className="text-red-500">*</span></label>
                        <input type="text" id="companyName" name="companyName" value={formData.companyName} onChange={handleChange}
                          className={`mt-1 block w-full px-3 py-2 border ${getValidationBorderClass('companyName', errors)} rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 pr-10`} />
                        {getValidationIcon('companyName', formData, errors)}
                        {errors.companyName && <p className="text-red-500 text-xs mt-1">{errors.companyName}</p>}
                      </div>
                      <div className="relative">
                        <label htmlFor="contactPerson" className="block text-sm font-medium text-gray-700">Contact Person <span className="text-red-500">*</span></label>
                        <input type="text" id="contactPerson" name="contactPerson" value={formData.contactPerson} onChange={handleChange}
                          className={`mt-1 block w-full px-3 py-2 border ${getValidationBorderClass('contactPerson', errors)} rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 pr-10`} />
                        {getValidationIcon('contactPerson', formData, errors)}
                        {errors.contactPerson && <p className="text-red-500 text-xs mt-1">{errors.contactPerson}</p>}
                      </div>
                      <div className="relative">
                        <label htmlFor="email" className="block text-sm font-medium text-gray-700">Email <span className="text-red-500">*</span></label>
                        <input type="email" id="email" name="email" value={formData.email} onChange={handleChange}
                          className={`mt-1 block w-full px-3 py-2 border ${getValidationBorderClass('email', errors)} rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 pr-10`} />
                        {getValidationIcon('email', formData, errors)}
                        {errors.email && <p className="text-red-500 text-xs mt-1">{errors.email}</p>}
                      </div>
                      <div className="relative">
                        <label htmlFor="countryCode" className="block text-sm font-medium text-gray-700">Country Code <span className="text-red-500">*</span></label>
                        <select id="countryCode" name="countryCode" value={formData.countryCode} onChange={handleChange}
                          className={`mt-1 block w-full px-3 py-2 border ${getValidationBorderClass('countryCode', errors)} rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 pr-10`}>
                          <option value="IN">India (+91)</option>
                          <option value="US">United States (+1)</option>
                          <option value="GB">United Kingdom (+44)</option>
                          <option value="CA">Canada (+1)</option>
                          <option value="AU">Australia (+61)</option>
                          <option value="Other">Other</option>
                        </select>
                        {getValidationIcon('countryCode', formData, errors)}
                        {errors.countryCode && <p className="text-red-500 text-xs mt-1">{errors.countryCode}</p>}
                      </div>
                      <div className="relative">
                        <label htmlFor="phone" className="block text-sm font-medium text-gray-700">Phone Number <span className="text-red-500">*</span></label>
                        <input type="tel" id="phone" name="phone" value={formData.phone} onChange={handleChange} placeholder={phonePlaceholder}
                          className={`mt-1 block w-full px-3 py-2 border ${getValidationBorderClass('phone', errors)} rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 pr-10`} />
                        {getValidationIcon('phone', formData, errors)}
                        {errors.phone && <p className="text-red-500 text-xs mt-1">{errors.phone}</p>}
                      </div>

                      {/* Reordered City, State, Pincode */}
                      {formData.countryCode === 'IN' ? (
                        <>
                          <div className="relative">
                            <label htmlFor="state" className="block text-sm font-medium text-gray-700">State <span className="text-red-500">*</span></label>
                            <input type="text" id="state" name="state" value={formData.state} onChange={handleChange} list="statesList"
                              className={`mt-1 block w-full px-3 py-2 border ${getValidationBorderClass('state', errors)} rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 pr-10`} />
                            <datalist id="statesList">
                                {Object.keys(indianStatesAndCities).sort().map(stateName => (
                                    <option key={stateName} value={stateName} />
                                ))}
                            </datalist>
                            {getValidationIcon('state', formData, errors)}
                            {errors.state && <p className="text-red-500 text-xs mt-1">{errors.state}</p>}
                          </div>
                          <div className="relative">
                            <label htmlFor="city" className="block text-sm font-medium text-gray-700">City <span className="text-red-500">*</span></label>
                            <input type="text" id="city" name="city" value={formData.city} onChange={handleChange} list="citiesList"
                              className={`mt-1 block w-full px-3 py-2 border ${getValidationBorderClass('city', errors)} rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 pr-10`} />
                            <datalist id="citiesList">
                                {currentCities.sort().map(city => (
                                    <option key={city} value={city} />
                                ))}
                            </datalist>
                            {getValidationIcon('city', formData, errors)}
                            {errors.city && <p className="text-red-500 text-xs mt-1">{errors.city}</p>}
                          </div>
                        </>
                      ) : (
                        <>
                          <div className="relative">
                            <label htmlFor="state" className="block text-sm font-medium text-gray-700">State <span className="text-red-500">*</span></label>
                            <input type="text" id="state" name="state" value={formData.state} onChange={handleChange}
                              className={`mt-1 block w-full px-3 py-2 border ${getValidationBorderClass('state', errors)} rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 pr-10`} />
                            {getValidationIcon('state', formData, errors)}
                            {errors.state && <p className="text-red-500 text-xs mt-1">{errors.state}</p>}
                          </div>
                          <div className="relative">
                            <label htmlFor="city" className="block text-sm font-medium text-gray-700">City <span className="text-red-500">*</span></label>
                            <input type="text" id="city" name="city" value={formData.city} onChange={handleChange}
                              className={`mt-1 block w-full px-3 py-2 border ${getValidationBorderClass('city', errors)} rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 pr-10`} />
                            {getValidationIcon('city', formData, errors)}
                            {errors.city && <p className="text-red-500 text-xs mt-1">{errors.city}</p>}
                          </div>
                        </>
                      )}

                      <div className="relative">
                        <label htmlFor="pincode" className="block text-sm font-medium text-gray-700">Pincode <span className="text-red-500">*</span></label>
                        <input type="text" id="pincode" name="pincode" value={formData.pincode} onChange={handleChange}
                          className={`mt-1 block w-full px-3 py-2 border ${getValidationBorderClass('pincode', errors)} rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 pr-10`} />
                        {getValidationIcon('pincode', formData, errors)}
                        {errors.pincode && <p className="text-red-500 text-xs mt-1">{errors.pincode}</p>}
                      </div>

                      {/* Original Address field, now after city/state/pincode */}
                      <div className="md:col-span-2 relative">
                        <label htmlFor="address" className="block text-sm font-medium text-gray-700">Complete Address <span className="text-red-500">*</span></label>
                        <textarea id="address" name="address" value={formData.address} onChange={handleChange} rows="3"
                          className={`mt-1 block w-full px-3 py-2 border ${getValidationBorderClass('address', errors)} rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 pr-10`}></textarea>
                        {getValidationIcon('address', formData, errors)}
                        {errors.address && <p className="text-red-500 text-xs mt-1">{errors.address}</p>}
                      </div>
                    </div>
                  </>
                )}
                {currentStep === 2 && (
                  <>
                    <h3 className="text-xl font-semibold text-gray-800 mb-6">Legal & Financial Compliance</h3>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                      <div className="relative">
                        <label htmlFor="legalEntityType" className="block text-sm font-medium text-gray-700">Legal Entity Type <span className="text-red-500">*</span></label>
                        <select id="legalEntityType" name="legalEntityType" value={formData.legalEntityType} onChange={handleChange}
                          className={`mt-1 block w-full px-3 py-2 border ${getValidationBorderClass('legalEntityType', errors)} rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 pr-10`}>
                          <option value="">Select Type</option>
                          <option value="Proprietorship">Proprietorship</option>
                          <option value="Partnership">Partnership</option>
                          <option value="LLP">Limited Liability Partnership (LLP)</option>
                          <option value="Pvt Ltd Co">Private Limited Company</option>
                          <option value="Public Ltd Co">Public Limited Company</option>
                          <option value="Other">Other</option>
                        </select>
                        {getValidationIcon('legalEntityType', formData, errors)}
                        {errors.legalEntityType && <p className="text-red-500 text-xs mt-1">{errors.legalEntityType}</p>}
                      </div>
                      {formData.legalEntityType === 'Other' && (
                        <div className="relative">
                          <label htmlFor="otherLegalEntityType" className="block text-sm font-medium text-gray-700">Specify Other Legal Entity Type <span className="text-red-500">*</span></label>
                          <input type="text" id="otherLegalEntityType" name="otherLegalEntityType" value={formData.otherLegalEntityType} onChange={handleChange}
                            className={`mt-1 block w-full px-3 py-2 border ${getValidationBorderClass('otherLegalEntityType', errors)} rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 pr-10`} />
                          {getValidationIcon('otherLegalEntityType', formData, errors)}
                          {errors.otherLegalEntityType && <p className="text-red-500 text-xs mt-1">{errors.otherLegalEntityType}</p>}
                        </div>
                      )}
                      <div className="relative">
                        <label htmlFor="pan" className="block text-sm font-medium text-gray-700">PAN (Permanent Account Number) <span className="text-red-500">*</span></label>
                        <input type="text" id="pan" name="pan" value={formData.pan} onChange={handleChange} placeholder="e.g., ABCDE1234F"
                          className={`mt-1 block w-full px-3 py-2 border ${getValidationBorderClass('pan', errors)} rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 pr-10`} />
                        {getValidationIcon('pan', formData, errors)}
                        {errors.pan && <p className="text-red-500 text-xs mt-1">{errors.pan}</p>}
                      </div>
                      <div className="relative">
                        <label htmlFor="gstin" className="block text-sm font-medium text-gray-700">GSTIN (Goods and Services Tax Identification Number)</label>
                        <input type="text" id="gstin" name="gstin" value={formData.gstin} onChange={handleChange} placeholder="e.g., 22AAAAA0000A1Z5"
                          className={`mt-1 block w-full px-3 py-2 border ${getValidationBorderClass('gstin', errors)} rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 pr-10`} />
                        {getValidationIcon('gstin', formData, errors)}
                        {errors.gstin && <p className="text-red-500 text-xs mt-1">{errors.gstin}</p>}
                      </div>

                      {/* MSME Registration Section */}
                      <div className="md:col-span-2">
                        <label className="block text-sm font-medium text-gray-700">MSME Registered? <span className="text-red-500">*</span></label>
                        <div className="mt-2 flex space-x-4">
                          <label className="inline-flex items-center">
                            <input type="radio" name="isMsmeRegistered" value="true" checked={formData.isMsmeRegistered === true} onChange={handleChange}
                              className={`form-radio text-blue-600 h-4 w-4 ${errors.isMsmeRegistered ? 'border-red-500' : ''}`} />
                            <span className="ml-2 text-gray-700">Yes</span>
                          </label>
                          <label className="inline-flex items-center">
                            <input type="radio" name="isMsmeRegistered" value="false" checked={formData.isMsmeRegistered === false} onChange={handleChange}
                              className={`form-radio text-blue-600 h-4 w-4 ${errors.isMsmeRegistered ? 'border-red-500' : ''}`} />
                            <span className="ml-2 text-gray-700">No</span>
                          </label>
                        </div>
                        {errors.isMsmeRegistered && <p className="text-red-500 text-xs mt-1">{errors.isMsmeRegistered}</p>}
                      </div>

                      {/* Prior Business Relationship Section */}
                      <div className="md:col-span-2">
                        <label className="block text-sm font-medium text-gray-700">Do you have any prior business relationship with Together or any employee in Together? <span className="text-red-500">*</span></label>
                        <div className="mt-2 flex space-x-4">
                          <label className="inline-flex items-center">
                            <input type="radio" name="hasPriorRelationship" value="true" checked={formData.hasPriorRelationship === true} onChange={handleChange}
                              className={`form-radio text-blue-600 h-4 w-4 ${errors.hasPriorRelationship ? 'border-red-500' : ''}`} />
                            <span className="ml-2 text-gray-700">Yes</span>
                          </label>
                          <label className="inline-flex items-center">
                            <input type="radio" name="hasPriorRelationship" value="false" checked={formData.hasPriorRelationship === false} onChange={handleChange}
                              className={`form-radio text-blue-600 h-4 w-4 ${errors.hasPriorRelationship ? 'border-red-500' : ''}`} />
                            <span className="ml-2 text-gray-700">No</span>
                          </label>
                        </div>
                        {errors.hasPriorRelationship && <p className="text-red-500 text-xs mt-1">{errors.hasPriorRelationship}</p>}
                      </div>


                      <div className="md:col-span-2">
                        <h4 className="text-md font-medium text-gray-800 mt-4 mb-2">Bank Account Details (for Payments)</h4>
                        <div className="relative">
                          <label htmlFor="bankName" className="block text-sm font-medium text-gray-700">Bank Name <span className="text-red-500">*</span></label>
                          <input type="text" id="bankName" name="bankName" value={formData.bankName} onChange={handleChange} list="indianBanksList"
                            className={`mt-1 block w-full px-3 py-2 border ${getValidationBorderClass('bankName', errors)} rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 pr-10`} />
                          <datalist id="indianBanksList">
                              {indianBankNames.sort().map(bank => (
                                  <option key={bank} value={bank} />
                              ))}
                          </datalist>
                          {getValidationIcon('bankName', formData, errors)}
                          {errors.bankName && <p className="text-red-500 text-xs mt-1">{errors.bankName}</p>}
                        </div>
                        <div className="mt-4 relative">
                          <label htmlFor="accountNumber" className="block text-sm font-medium text-gray-700">Account Number <span className="text-red-500">*</span></label>
                          <input type="text" id="accountNumber" name="accountNumber" value={formData.accountNumber} onChange={handleChange}
                            className={`mt-1 block w-full px-3 py-2 border ${getValidationBorderClass('accountNumber', errors)} rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 pr-10`} />
                          {getValidationIcon('accountNumber', formData, errors)}
                          {errors.accountNumber && <p className="text-red-500 text-xs mt-1">{errors.accountNumber}</p>}
                        </div>
                        <div className="mt-4 relative">
                          <label htmlFor="ifscCode" className="block text-sm font-medium text-gray-700">IFSC Code <span className="text-red-500">*</span></label>
                          <input type="text" id="ifscCode" name="ifscCode" value={formData.ifscCode} onChange={handleChange} placeholder="e.g., ABCD0123456"
                            className={`mt-1 block w-full px-3 py-2 border ${getValidationBorderClass('ifscCode', errors)} rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 pr-10`} />
                          {getValidationIcon('ifscCode', formData, errors)}
                          {errors.ifscCode && <p className="text-red-500 text-xs mt-1">{errors.ifscCode}</p>}
                        </div>
                      </div>
                    </div>
                  </>
                )}
                {currentStep === 3 && (
                  <>
                    <h3 className="text-xl font-semibold text-gray-800 mb-6">Operational Capabilities & Experience</h3>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                      {/* New: Suitable For dropdown */}
                      <div className="relative">
                        <label htmlFor="suitableFor" className="block text-sm font-medium text-gray-700">Suitable For <span className="text-red-500">*</span></label>
                        <select id="suitableFor" name="suitableFor" value={formData.suitableFor} onChange={handleChange}
                          className={`mt-1 block w-full px-3 py-2 border ${getValidationBorderClass('suitableFor', errors)} rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 pr-10`}>
                          <option value="">Select an option</option>
                          {suitableForOptions.map(option => (
                            <option key={option} value={option}>{option}</option>
                          ))}
                        </select>
                        {getValidationIcon('suitableFor', formData, errors)}
                        {errors.suitableFor && <p className="text-red-500 text-xs mt-1">{errors.suitableFor}</p>}
                      </div>

                      {/* New: Service Category dropdown */}
                      <div className="relative">
                        <label htmlFor="serviceCategory" className="block text-sm font-medium text-gray-700">Service Category <span className="text-red-500">*</span></label>
                        <select id="serviceCategory" name="serviceCategory" value={formData.serviceCategory} onChange={handleChange}
                          className={`mt-1 block w-full px-3 py-2 border ${getValidationBorderClass('serviceCategory', errors)} rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 pr-10`}>
                          <option value="">Select a category</option>
                          {Object.keys(serviceCategories).sort().map(category => (
                            <option key={category} value={category}>{category}</option>
                          ))}
                        </select>
                        {getValidationIcon('serviceCategory', formData, errors)}
                        {errors.serviceCategory && <p className="text-red-500 text-xs mt-1">{errors.serviceCategory}</p>}
                      </div>

                      {/* New: Service Subcategory dropdown (dynamic) */}
                      <div className="relative">
                        <label htmlFor="serviceSubcategory" className="block text-sm font-medium text-gray-700">Service Subcategory <span className="text-red-500">*</span></label>
                        <select id="serviceSubcategory" name="serviceSubcategory" value={formData.serviceSubcategory} onChange={handleChange}
                          className={`mt-1 block w-full px-3 py-2 border ${getValidationBorderClass('serviceSubcategory', errors)} rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 pr-10`}
                          disabled={!formData.serviceCategory}>
                          <option value="">Select a subcategory</option>
                          {currentSubcategories.sort().map(sub => (
                            <option key={sub} value={sub}>{sub}</option>
                          ))}
                        </select>
                        {getValidationIcon('serviceSubcategory', formData, errors)}
                        {errors.serviceSubcategory && <p className="text-red-500 text-xs mt-1">{errors.serviceSubcategory}</p>}
                      </div>

                      <div className="relative">
                        <label htmlFor="yearsInBusiness" className="block text-sm font-medium text-gray-700">Years in Business <span className="text-red-500">*</span></label>
                        <input type="number" id="yearsInBusiness" name="yearsInBusiness" value={formData.yearsInBusiness} onChange={handleChange} min="0"
                          className={`mt-1 block w-full px-3 py-2 border ${getValidationBorderClass('yearsInBusiness', errors)} rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 pr-10`} />
                        {getValidationIcon('yearsInBusiness', formData, errors)}
                        {errors.yearsInBusiness && <p className="text-red-500 text-xs mt-1">{errors.yearsInBusiness}</p>}
                      </div>
                      <div className="md:col-span-2">
                        <label htmlFor="references" className="block text-sm font-medium text-gray-700">Client References (Optional, provide names/contact if possible)</label>
                        <textarea id="references" name="references" value={formData.references} onChange={handleChange} rows="3"
                          className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></textarea>
                      </div>
                    </div>
                  </>
                )}
                {currentStep === 4 && (
                  <>
                    <h3 className="text-xl font-semibold text-gray-800 mb-6">Compliance, Confidentiality & Security</h3>
                    <div className="space-y-4">
                      {/* Download Agreement Section */}
                      <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                        <p className="text-sm font-medium text-blue-800 mb-3">
                          Please download and review our standard Supplier Agreement and Compliance Policy. You will be required to upload the signed version on the final step.
                        </p>
                        <div className="flex flex-col sm:flex-row gap-3">
                          <a
                            href="https://example.com/Draft_Supplier_Agreement.pdf" // Placeholder URL
                            target="_blank"
                            rel="noopener noreferrer"
                            className="inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
                          >
                            Download Supplier Agreement
                          </a>
                          <a
                            href="https://example.com/Compliance_Policy.pdf" // Placeholder URL
                            target="_blank"
                            rel="noopener noreferrer"
                            className="inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-blue-700 bg-blue-100 hover:bg-blue-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
                          >
                            Download Compliance Policy
                          </a>
                        </div>
                        <p className="text-xs text-gray-500 mt-2">
                            (Note: These are placeholder download links. In a live environment, replace with actual hosted file URLs.)
                        </p>
                      </div>

                      <div className="flex items-start">
                        <input type="checkbox" id="agreeToCodeOfConduct" name="agreeToCodeOfConduct" checked={formData.agreeToCodeOfConduct} onChange={handleChange}
                          className={`h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500 ${errors.agreeToCodeOfConduct ? 'border-red-500' : ''}`} />
                        <label htmlFor="agreeToCodeOfConduct" className="ml-3 block text-sm text-gray-700">
                          I agree to comply with Together Events' Code of Conduct and all applicable Indian laws (labor, tax, etc.), including anti-bribery/corruption policies. <span className="text-red-500">*</span>
                        </label>
                      </div>
                      {errors.agreeToCodeOfConduct && <p className="text-red-500 text-xs mt-1 ml-7">{errors.agreeToCodeOfConduct}</p>}

                      <div className="flex items-start mt-4">
                        <input type="checkbox" id="agreeToDataSecurity" name="agreeToDataSecurity" checked={formData.agreeToDataSecurity} onChange={handleChange}
                          className={`h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500 ${errors.agreeToDataSecurity ? 'border-red-500' : ''}`} />
                        <label htmlFor="agreeToDataSecurity" className="ml-3 block text-sm text-gray-700">
                          I agree to adhere to Indian data protection laws (IT Act, 2000; DPDP Act, 2023) and Together Events' Information Security Standards. I will notify Together Events within 24 hours of any data breach and cooperate with security audits. <span className="text-red-500">*</span>
                        </label>
                      </div>
                      {errors.agreeToDataSecurity && <p className="text-red-500 text-xs mt-1 ml-7">{errors.agreeToDataSecurity}</p>}
                    </div>
                  </>
                )}
                {currentStep === 5 && (
                  <>
                    <h3 className="text-xl font-semibold text-gray-800 mb-6">Subcontractor & Personnel Management</h3>
                    <div className="space-y-6">
                      <div>
                        <label className="block text-sm font-medium text-gray-700">Is prior approval required for critical subcontractors?</label>
                        <div className="mt-2 flex space-x-4">
                          <label className="inline-flex items-center">
                            <input type="radio" name="subcontractorApprovalRequired" value="Yes" checked={formData.subcontractorApprovalRequired === 'Yes'} onChange={handleChange}
                              className="form-radio text-blue-600 h-4 w-4" />
                            <span className="ml-2 text-gray-700">Yes</span>
                          </label>
                          <label className="inline-flex items-center">
                            <input type="radio" name="subcontractorApprovalRequired" value="No" checked={formData.subcontractorApprovalRequired === 'No'} onChange={handleChange}
                              className="form-radio text-blue-600 h-4 w-4" />
                            <span className="ml-2 text-gray-700">No</span>
                          </label>
                        </div>
                      </div>

                      {formData.subcontractorApprovalRequired === 'Yes' && (
                        <div className="relative">
                          <label htmlFor="subcontractorVettingProcess" className="block text-sm font-medium text-gray-700">Describe your subcontractor vetting and background check process (as permissible by Indian law). <span className="text-red-500">*</span></label>
                          <textarea id="subcontractorVettingProcess" name="subcontractorVettingProcess" value={formData.subcontractorVettingProcess} onChange={handleChange} rows="3"
                            className={`mt-1 block w-full px-3 py-2 border ${getValidationBorderClass('subcontractorVettingProcess', errors)} rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 pr-10`}></textarea>
                          {getValidationIcon('subcontractorVettingProcess', formData, errors)}
                          {errors.subcontractorVettingProcess && <p className="text-red-500 text-xs mt-1">{errors.subcontractorVettingProcess}</p>}
                        </div>
                      )}

                      <div className="flex items-start">
                        <input type="checkbox" id="preventWorkIrregularities" name="preventWorkIrregularities" checked={formData.preventWorkIrregularities} onChange={handleChange}
                          className={`h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500 ${errors.preventWorkIrregularities ? 'border-red-500' : ''}`} />
                        <label htmlFor="preventWorkIrregularities" className="ml-3 block text-sm text-gray-700">
                          I confirm that our company has clear policies and mechanisms to prevent work irregularities, theft, fraud, harassment, discrimination, or any extreme human behavior concerns by our personnel/subcontractors, and we will report such incidents immediately. <span className="text-red-500">*</span>
                        </label>
                      </div>
                      {errors.preventWorkIrregularities && <p className="text-red-500 text-xs mt-1 ml-7">{errors.preventWorkIrregularities}</p>}
                    </div>
                  </>
                )}
                {currentStep === 6 && (
                  <>
                    <h3 className="text-xl font-semibold text-gray-800 mb-6">Required Document Uploads & Declaration</h3>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                      {/* PAN Document */}
                      <DocumentUploadField
                          label={labelMap.panDocument}
                          name="panDocument"
                          file={formData.panDocument}
                          onFileChange={handleDocumentFileChange('panDocument')}
                          onRemoveFile={removeDocumentFile('panDocument')}
                          error={errors.panDocument}
                      />

                      {/* GST Document */}
                      <DocumentUploadField
                          label={labelMap.gstDocument}
                          name="gstDocument"
                          file={formData.gstDocument}
                          onFileChange={handleDocumentFileChange('gstDocument')}
                          onRemoveFile={removeDocumentFile('gstDocument')}
                          error={errors.gstDocument}
                      />

                      {/* MSME Document (conditional) */}
                      {formData.isMsmeRegistered && (
                          <DocumentUploadField
                              label={labelMap.msmeDocument}
                              name="msmeDocument"
                              file={formData.msmeDocument}
                              onFileChange={handleDocumentFileChange('msmeDocument')}
                              onRemoveFile={removeDocumentFile('msmeDocument')}
                              error={errors.msmeDocument}
                          />
                      )}

                      {/* Cancelled Cheque Document */}
                      <DocumentUploadField
                          label={labelMap.cancelledChequeDocument}
                          name="cancelledChequeDocument"
                          file={formData.cancelledChequeDocument}
                          onFileChange={handleDocumentFileChange('cancelledChequeDocument')}
                          onRemoveFile={removeDocumentFile('cancelledChequeDocument')}
                          error={errors.cancelledChequeDocument}
                      />

                      {/* Company Proof Document */}
                      <DocumentUploadField
                          label={labelMap.companyProofDocument}
                          name="companyProofDocument"
                          file={formData.companyProofDocument}
                          onFileChange={handleDocumentFileChange('companyProofDocument')}
                          onRemoveFile={removeDocumentFile('companyProofDocument')}
                          error={errors.companyProofDocument}
                      />

                      {/* Agreement Document */}
                      <DocumentUploadField
                          label={labelMap.agreementDocument}
                          name="agreementDocument"
                          file={formData.agreementDocument}
                          onFileChange={handleDocumentFileChange('agreementDocument')}
                          onRemoveFile={removeDocumentFile('agreementDocument')}
                          error={errors.agreementDocument}
                      />

                      {/* Compliance Policy Document */}
                      <DocumentUploadField
                          label={labelMap.compliancePolicyDocument}
                          name="compliancePolicyDocument"
                          file={formData.compliancePolicyDocument}
                          onFileChange={handleDocumentFileChange('compliancePolicyDocument')}
                          onRemoveFile={removeDocumentFile('compliancePolicyDocument')}
                          error={errors.compliancePolicyDocument}
                      />

                      <div className="md:col-span-2 flex items-start mt-8">
                        <input type="checkbox" id="ipAssignment" name="ipAssignment" checked={formData.ipAssignment} onChange={handleChange}
                          className={`h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500 ${errors.ipAssignment ? 'border-red-500' : ''}`} />
                        <label htmlFor="ipAssignment" className="ml-3 block text-sm text-gray-700">
                          I acknowledge and agree that all Intellectual Property created by us for Together Events shall be automatically assigned to Together Events. <span className="text-red-500">*</span>
                        </label>
                      </div>
                      {errors.ipAssignment && <p className="text-red-500 text-xs mt-1 ml-7">{errors.ipAssignment}</p>}
                    </div>
                  </>
                )}
              </>
            );
          };

          return (
            <div className="bg-white rounded-xl shadow-lg p-8 max-w-3xl mx-auto my-10">
              <h2 className="text-3xl font-extrabold text-gray-900 text-center mb-8">Supplier Onboarding Form</h2>

              {/* Progress Bar */}
              <div className="flex justify-between mb-8">
                {[...Array(totalSteps)].map((_, index) => (
                  <div key={index} className="flex-1 flex flex-col items-center">
                    <div className={`w-10 h-10 rounded-full flex items-center justify-center text-white font-bold
                      ${index + 1 === currentStep ? 'bg-blue-600' : index + 1 < currentStep ? 'bg-green-500' : 'bg-gray-300'}`}>
                      {index + 1 < currentStep ? <CheckCircle size={20} /> : index + 1}
                    </div>
                    {index < totalSteps - 1 && (
                      <div className={`flex-1 h-1 bg-gray-300 -mt-5 ${index + 1 < currentStep ? 'bg-green-500' : ''}`} style={{ width: 'calc(100% - 2.5rem)', marginLeft: '1.25rem', marginRight: '1.25rem' }}></div>
                    )}
                  </div>
                ))}
              </div>


              <form onSubmit={handleSubmit}>
                {renderStepContent()}

                <div className="flex justify-between mt-10">
                  {currentStep > 1 && (
                    <button
                      type="button"
                      onClick={prevStep}
                      className="flex items-center px-6 py-3 bg-gray-200 text-gray-800 rounded-lg shadow-md hover:bg-gray-300 transition-colors duration-200 font-semibold"
                    >
                      <ChevronLeft className="mr-2" size={20} /> Previous
                    </button>
                  )}

                  {currentStep < totalSteps ? (
                    <button
                      type="button"
                      onClick={nextStep}
                      className="flex items-center px-6 py-3 bg-blue-600 text-white rounded-lg shadow-md hover:bg-blue-700 transition-colors duration-200 font-semibold ml-auto"
                    >
                      Next <ChevronRight className="ml-2" size={20} />
                    </button>
                  ) : (
                    <button
                      type="submit"
                      className="flex items-center px-8 py-3 bg-green-600 text-white rounded-lg shadow-md hover:bg-green-700 transition-colors duration-200 font-semibold ml-auto"
                      disabled={isSubmitting}
                    >
                      {isSubmitting ? <LoadingSpinner message="" /> : 'Submit Form'}
                    </button>
                  )}
                </div>
              </form>

              <Modal isOpen={modalOpen} onClose={() => setModalOpen(false)} title={modalContent.title} type={modalContent.type}>
                <p>{modalContent.message}</p>
              </Modal>
            </div>
          );
        };

        // SupplierDashboard Component
        const SupplierDashboard = () => {
          const { userId, isAuthReady, db } = useAuth();
          const [suppliers, setSuppliers] = useState([]);
          const [loading, setLoading] = useState(true);
          const [error, setError] = useState(null);
          const [selectedSupplier, setSelectedSupplier] = useState(null);
          const [isViewModalOpen, setIsViewModalOpen] = useState(false);
          const [isConfirmDeleteModalOpen, setIsConfirmDeleteModalOpen] = useState(false);
          const [supplierToDelete, setSupplierToDelete] = useState(null);
          const [isEditModalOpen, setIsEditModalOpen] = useState(false);
          const [editFormData, setEditFormData] = useState({});
          const [isSaving, setIsSaving] = useState(false);
          const [searchTerm, setSearchTerm] = useState('');
          const [sortConfig, setSortConfig] = useState({ key: null, direction: 'ascending' });
          const [isRateModalOpen, setIsRateModalOpen] = useState(false);
          const [ratingInput, setRatingInput] = useState(0);
          const [ratingComment, setRatingComment] = useState('');
          const [minRatingFilter, setMinRatingFilter] = useState(0); // For filtering by average rating

          // Firebase modular imports (assuming they are globally available or mocked)
          const { collection, onSnapshot, doc, updateDoc, deleteDoc } = window.firebase.firestore();

          // Mapping for display labels for document fields
          const labelMap = {
              panDocument: 'PAN Document',
              gstDocument: 'GST Document',
              msmeDocument: 'MSME Document',
              cancelledChequeDocument: 'Cancelled Cheque',
              companyProofDocument: 'Company Proof',
              agreementDocument: 'Agreement',
              compliancePolicyDocument: 'Compliance Policy'
          };

          // Fetch suppliers in real-time using onSnapshot
          useEffect(() => {
            if (!isAuthReady || !db) {
              setLoading(true); // Keep loading state true until auth/db is ready
              return;
            }

            // Determine appId for Firestore path
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            // Use the collection function from the Firebase instance exposed by AuthContext
            const suppliersCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'suppliers');

            // Set up real-time listener
            const unsubscribe = onSnapshot(suppliersCollectionRef,
              (snapshot) => {
                const fetchedSuppliers = [];
                snapshot.forEach(doc => {
                  const data = doc.data();
                  fetchedSuppliers.push({
                    id: doc.id,
                    ...data,
                    // Convert Firestore timestamp to a readable date string
                    submissionDate: data.submissionDate ? new Date(data.submissionDate.seconds * 1000).toLocaleString() : 'N/A'
                  });
                });
                setSuppliers(fetchedSuppliers);
                setLoading(false);
              },
              (err) => {
                console.error("Error fetching suppliers:", err);
                setError("Failed to load suppliers. Please ensure your backend is running and Firestore rules are correct.");
                setLoading(false);
              }
            );

            // Clean up the listener when the component unmounts
            return () => unsubscribe();
          }, [isAuthReady, db, collection, onSnapshot]); // Depend on auth readiness and db instance

          const handleViewDetails = (supplier) => {
            setSelectedSupplier(supplier);
            setIsViewModalOpen(true);
          };

          const handleEdit = (supplier) => {
            setSelectedSupplier(supplier);
            setEditFormData({ ...supplier }); // Copy current data for editing
            setIsEditModalOpen(true);
          };

          const handleEditChange = (e) => {
            const { name, value, type, checked, files } = e.target;
            let newValue;

            if (type === 'file') {
                newValue = files && files.length > 0 ? files[0] : null;
            } else if (type === 'checkbox') {
                newValue = checked;
            } else if (name === 'isMsmeRegistered' || name === 'hasPriorRelationship') {
                newValue = value === 'true';
                if (name === 'isMsmeRegistered' && !newValue) {
                    setEditFormData(prev => ({ ...prev, msmeDocument: null }));
                }
            } else {
                newValue = value;
            }

            // Special handling for serviceCategory change to reset subcategory
            if (name === 'serviceCategory') {
                setEditFormData(prev => ({
                    ...prev,
                    serviceSubcategory: '', // Reset subcategory when category changes
                    [name]: newValue
                }));
            } else {
                setEditFormData(prev => ({
                    ...prev,
                    [name]: newValue
                }));
            }
          };

          const handleSaveEdit = async () => {
            if (!selectedSupplier) return;

            setIsSaving(true);
            try {
              const formPayload = new FormData();
              // Append all form data fields
              for (const key in editFormData) {
                // Exclude 'id', 'submissionDate', 'documents', 'ratings', 'averageRating'
                // Handle file objects separately as they are File instances or null
                if (key !== 'id' && key !== 'submissionDate' && key !== 'ratings' && key !== 'averageRating' && !(editFormData[key] instanceof File) && editFormData[key] !== null) {
                  formPayload.append(key, editFormData[key]);
                }
              }

              // Append individual document files (only if they are File instances, not existing objects)
              const documentFields = ['panDocument', 'gstDocument', 'msmeDocument', 'cancelledChequeDocument', 'companyProofDocument', 'agreementDocument', 'compliancePolicyDocument'];
              documentFields.forEach(docField => {
                  if (editFormData[docField] instanceof File) {
                      formPayload.append(docField, editFormData[docField]);
                  } else if (editFormData[docField] === null && selectedSupplier[docField]) {
                      // If a document was removed (set to null) and existed previously, send a flag to backend to clear it
                      formPayload.append(docField, 'null');
                  }
              });


              const response = await fetch(`${BACKEND_BASE_URL}/api/suppliers/${selectedSupplier.id}`, {
                method: 'PUT',
                body: formPayload,
              });

              if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || 'Failed to update supplier');
              }

              setIsEditModalOpen(false);
              setSelectedSupplier(null);
              setEditFormData({});
              setModalContent({ title: 'Success', message: 'Supplier updated successfully!', type: 'success' });
              setModalOpen(true);
            } catch (error) {
              console.error('Error saving supplier:', error);
              setModalContent({ title: 'Error', message: `Failed to save supplier: ${error.message}`, type: 'error' });
              setModalOpen(true);
            } finally {
              setIsSaving(false);
            }
          };

          const handleDocumentVerificationToggle = async (supplierId, docFieldName, currentVerifiedStatus) => {
            setIsSaving(true); // Indicate saving state
            try {
              const endpoint = `${BACKEND_BASE_URL}/api/suppliers/${supplierId}/document/${docFieldName}/verify`;

              const response = await fetch(endpoint, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ verified: !currentVerifiedStatus }),
              });

              if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || 'Failed to update document verification status');
              }

              // Update local state to reflect change immediately (optional, onSnapshot will eventually update)
              setSuppliers(prevSuppliers => prevSuppliers.map(s => {
                if (s.id === supplierId) {
                  return {
                    ...s,
                    [docFieldName]: s[docFieldName] ? { ...s[docFieldName], verified: !currentVerifiedStatus } : s[docFieldName]
                  };
                }
                return s;
              }));

              setModalContent({ title: 'Success', message: 'Document verification status updated.', type: 'success' });
              setModalOpen(true);
            } catch (error) {
              console.error('Error updating document verification:', error);
              setModalContent({ title: 'Error', message: `Failed to update document verification: ${error.message}`, type: 'error' });
              setModalOpen(true);
            } finally {
              setIsSaving(false);
            }
          };


          const handleDeleteConfirm = (supplier) => {
            setSupplierToDelete(supplier);
            setIsConfirmDeleteModalOpen(true);
          };

          const handleDelete = async () => {
            if (!supplierToDelete) return;

            setIsSaving(true); // Reusing saving state for deletion
            try {
              const response = await fetch(`${BACKEND_BASE_URL}/api/suppliers/${supplierToDelete.id}`, {
                method: 'DELETE',
              });

              if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || 'Failed to delete supplier');
              }

              setIsConfirmDeleteModalOpen(false);
              setSupplierToDelete(null);
              setModalContent({ title: 'Success', message: 'Supplier deleted successfully!', type: 'success' });
              setModalOpen(true);
            } catch (error) {
              console.error('Error deleting supplier:', error);
              setModalContent({ title: 'Error', message: `Failed to delete supplier: ${error.message}`, type: 'error' });
              setModalOpen(true);
            } finally {
              setIsSaving(false);
            }
          };

          const handleRateSupplier = (supplier) => {
            setSelectedSupplier(supplier);
            setRatingInput(0); // Reset rating input
            setRatingComment(''); // Reset comment
            setIsRateModalOpen(true);
          };

          const submitRating = async () => {
            if (!selectedSupplier || ratingInput === 0) {
              setModalContent({ title: 'Error', message: 'Please select a rating.', type: 'error' });
              setModalOpen(true);
              return;
            }
            if (!userId) {
                setModalContent({ title: 'Error', message: 'User not authenticated. Cannot submit rating.', type: 'error' });
                setModalOpen(true);
                return;
            }

            setIsSaving(true);
            try {
              const response = await fetch(`${BACKEND_BASE_URL}/api/suppliers/${selectedSupplier.id}/rate`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ score: ratingInput, comment: ratingComment, byUser: userId }),
              });

              if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || 'Failed to submit rating');
              }

              const result = await response.json();
              setIsRateModalOpen(false);
              setModalContent({ title: 'Success', message: `Rating submitted! New Average Rating: ${result.averageRating.toFixed(1)}`, type: 'success' });
              setModalOpen(true);
            } catch (error) {
              console.error('Error submitting rating:', error);
              setModalContent({ title: 'Error', message: `Failed to submit rating: ${error.message}`, type: 'error' });
              setModalOpen(true);
            } finally {
              setIsSaving(false);
            }
          };


          // Filtering logic
          const filteredSuppliers = suppliers.filter(supplier =>
            (supplier.companyName.toLowerCase().includes(searchTerm.toLowerCase()) ||
            supplier.contactPerson.toLowerCase().includes(searchTerm.toLowerCase())) &&
            (supplier.averageRating >= minRatingFilter)
          );

          // Sorting logic
          const sortedSuppliers = useCallback(() => {
            let sortableItems = [...filteredSuppliers];
            if (sortConfig.key !== null) {
              sortableItems.sort((a, b) => {
                const aValue = a[sortConfig.key];
                const bValue = b[sortConfig.key];

                // Special handling for date strings if needed, otherwise direct comparison
                if (sortConfig.key === 'submissionDate') {
                  const dateA = new Date(aValue);
                  const dateB = new Date(bValue);
                  if (dateA < dateB) return sortConfig.direction === 'ascending' ? -1 : 1;
                  if (dateA > dateB) return sortConfig.direction === 'ascending' ? 1 : -1;
                  return 0;
                }
                // Handle numbers for averageRating and yearsInBusiness
                if (sortConfig.key === 'averageRating' || sortConfig.key === 'yearsInBusiness') {
                    const numA = parseFloat(aValue) || 0;
                    const numB = parseFloat(bValue) || 0;
                    if (numA < numB) return sortConfig.direction === 'ascending' ? -1 : 1;
                    if (numA > numB) return sortConfig.direction === 'ascending' ? 1 : -1;
                    return 0;
                }


                if (aValue < bValue) {
                  return sortConfig.direction === 'ascending' ? -1 : 1;
                }
                if (aValue > bValue) {
                  return sortConfig.direction === 'ascending' ? 1 : -1;
                }
                return 0;
              });
            }
            return sortableItems;
          }, [filteredSuppliers, sortConfig]);

          const requestSort = (key) => {
            let direction = 'ascending';
            if (sortConfig.key === key && sortConfig.direction === 'ascending') {
              direction = 'descending';
            }
            setSortConfig({ key, direction });
          };

          const getSortIcon = (key) => {
            if (sortConfig.key !== key) return null;
            if (sortConfig.direction === 'ascending') return <ArrowUp size={14} className="ml-1" />;
            return <ArrowDown size={14} className="ml-1" />;
          };


          if (loading) {
            return <LoadingSpinner message="Loading supplier data..." />;
          }

          if (error) {
            return <div className="text-red-600 text-center p-4">{error}</div>;
          }

          return (
            <div className="bg-white rounded-xl shadow-lg p-8 max-w-6xl mx-auto my-10">
              <h2 className="text-3xl font-extrabold text-gray-900 text-center mb-8">Supplier Dashboard</h2>
              <p className="text-center text-gray-600 mb-6">
                Current User ID: <span className="font-mono bg-gray-100 p-1 rounded-md text-sm">{userId || 'N/A'}</span>
              </p>

              <div className="mb-6 flex flex-col sm:flex-row gap-4">
                <input
                  type="text"
                  placeholder="Search by company or contact person..."
                  value={searchTerm}
                  onChange={(e) => setSearchTerm(e.target.value)}
                  className="w-full sm:flex-1 px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                />
                <div className="flex items-center space-x-2 w-full sm:w-auto">
                    <label htmlFor="minRatingFilter" className="text-sm font-medium text-gray-700 whitespace-nowrap">Min Rating:</label>
                    <select
                        id="minRatingFilter"
                        value={minRatingFilter}
                        onChange={(e) => setMinRatingFilter(parseFloat(e.target.value))}
                        className="px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                    >
                        <option value="0">All</option>
                        <option value="1">1 Star & Up</option>
                        <option value="2">2 Stars & Up</option>
                        <option value="3">3 Stars & Up</option>
                        <option value="4">4 Stars & Up</option>
                        <option value="5">5 Stars</option>
                    </select>
                </div>
              </div>

              {sortedSuppliers().length === 0 ? (
                <div className="text-center text-gray-500 text-lg">No supplier data available. Submit a form to see data here.</div>
              ) : (
                <div className="overflow-x-auto rounded-lg shadow-md">
                  <table className="min-w-full divide-y divide-gray-200">
                    <thead className="bg-gray-50">
                      <tr>
                        <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider rounded-tl-lg cursor-pointer hover:bg-gray-100" onClick={() => requestSort('companyName')}>
                          <div className="flex items-center">Company Name {getSortIcon('companyName')}</div>
                        </th>
                        <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Contact Person</th>
                        <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                        <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                        <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" onClick={() => requestSort('averageRating')}>
                          <div className="flex items-center">Rating {getSortIcon('averageRating')}</div>
                        </th>
                        <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" onClick={() => requestSort('submissionDate')}>
                          <div className="flex items-center">Submission Date {getSortIcon('submissionDate')}</div>
                        </th>
                        <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider rounded-tr-lg">Actions</th>
                      </tr>
                    </thead>
                    <tbody className="bg-white divide-y divide-gray-200">
                      {sortedSuppliers().map((supplier) => (
                        <tr key={supplier.id} className="hover:bg-gray-50">
                          <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{supplier.companyName}</td>
                          <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-700">{supplier.contactPerson}</td>
                          <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-700">{supplier.email}</td>
                          <td className="px-6 py-4 whitespace-nowrap text-sm">
                            <span className={`px-2 inline-flex text-xs leading-5 font-semibold rounded-full
                              ${supplier.status === 'Approved' ? 'bg-green-100 text-green-800' :
                                supplier.status === 'Rejected' ? 'bg-red-100 text-red-800' :
                                'bg-yellow-100 text-yellow-800'}`}>
                              {supplier.status}
                            </span>
                          </td>
                          <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-700">
                            {supplier.averageRating > 0 ? (
                                <span className="flex items-center">
                                    {supplier.averageRating.toFixed(1)} <Star size={14} className="ml-1 text-yellow-500 fill-current" />
                                    ({supplier.ratings?.length || 0})
                                </span>
                            ) : 'N/A'}
                          </td>
                          <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-700">{supplier.submissionDate}</td>
                          <td className="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <div className="flex space-x-2">
                              <button
                                onClick={() => handleViewDetails(supplier)}
                                className="p-2 rounded-full bg-blue-100 text-blue-600 hover:bg-blue-200 transition-colors duration-200"
                                title="View Details"
                              >
                                <Eye size={18} />
                              </button>
                              <button
                                onClick={() => handleEdit(supplier)}
                                className="p-2 rounded-full bg-yellow-100 text-yellow-600 hover:bg-yellow-200 transition-colors duration-200"
                                title="Edit"
                              >
                                <Edit size={18} />
                              </button>
                              <button
                                onClick={() => handleRateSupplier(supplier)}
                                className="p-2 rounded-full bg-purple-100 text-purple-600 hover:bg-purple-200 transition-colors duration-200"
                                title="Rate Vendor"
                              >
                                <Star size={18} />
                              </button>
                              <button
                                onClick={() => handleDeleteConfirm(supplier)}
                                className="p-2 rounded-full bg-red-100 text-red-600 hover:bg-red-200 transition-colors duration-200"
                                title="Delete"
                              >
                                <Trash2 size={18} />
                              </button>
                            </div>
                          </td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              )}

              {/* View Details Modal */}
              <Modal isOpen={isViewModalOpen} onClose={() => setIsViewModalOpen(false)} title="Supplier Details">
                {selectedSupplier && (
                  <div className="space-y-4 text-gray-700 max-h-96 overflow-y-auto pr-2">
                    <p><strong>Company Name:</strong> {selectedSupplier.companyName}</p>
                    <p><strong>Contact Person:</strong> {selectedSupplier.contactPerson}</p>
                    <p><strong>Email:</strong> {selectedSupplier.email}</p>
                    <p><strong>Phone:</strong> {selectedSupplier.phone}</p>
                    <p><strong>Address:</strong> {selectedSupplier.address}, {selectedSupplier.city}, {selectedSupplier.state} - {selectedSupplier.pincode}, {selectedSupplier.countryCode}</p>
                    <p><strong>Legal Entity Type:</strong> {selectedSupplier.legalEntityType} {selectedSupplier.legalEntityType === 'Other' && `(${selectedSupplier.otherLegalEntityType})`}</p>
                    <p><strong>PAN:</strong> {selectedSupplier.pan}</p>
                    <p><strong>GSTIN:</strong> {selectedSupplier.gstin || 'N/A (Optional)'}</p>
                    <p><strong>MSME Registered:</strong> {selectedSupplier.isMsmeRegistered ? 'Yes' : 'No'}</p>
                    <p><strong>Prior Business Relationship with Together:</strong> {selectedSupplier.hasPriorRelationship ? 'Yes' : 'No'}</p>
                    <p><strong>Bank Name:</strong> {selectedSupplier.bankName}</p>
                    <p><strong>Account Number:</strong> {selectedSupplier.accountNumber}</p>
                    <p><strong>IFSC Code:</strong> {selectedSupplier.ifscCode}</p>
                    <p><strong>Suitable For:</strong> {selectedSupplier.suitableFor || 'N/A'}</p>
                    <p><strong>Service Category:</strong> {selectedSupplier.serviceCategory || 'N/A'}</p>
                    <p><strong>Service Subcategory:</strong> {selectedSupplier.serviceSubcategory || 'N/A'}</p>
                    <p><strong>Years in Business:</strong> {selectedSupplier.yearsInBusiness}</p>
                    <p><strong>References:</strong> {selectedSupplier.references || 'N/A'}</p>
                    <p><strong>Agrees to Code of Conduct:</strong> {selectedSupplier.agreeToCodeOfConduct ? 'Yes' : 'No'}</p>
                    <p><strong>Agrees to Data Security:</strong> {selectedSupplier.agreeToDataSecurity ? 'Yes' : 'No'}</p>
                    <p><strong>Subcontractor Approval Required:</strong> {selectedSupplier.subcontractorApprovalRequired}</p>
                    {selectedSupplier.subcontractorApprovalRequired === 'Yes' && (
                      <p><strong>Subcontractor Vetting Process:</strong> {selectedSupplier.subcontractorVettingProcess}</p>
                    )}
                    <p><strong>Prevents Work Irregularities:</strong> {selectedSupplier.preventWorkIrregularities ? 'Yes' : 'No'}</p>
                    <p><strong>IP Assignment:</strong> {selectedSupplier.ipAssignment ? 'Yes' : 'No'}</p>
                    <p><strong>Status:</strong> {selectedSupplier.status}</p>
                    <p><strong>Submission Date:</strong> {selectedSupplier.submissionDate}</p>

                    {/* Display Ratings */}
                    <div className="mt-4">
                        <p className="font-semibold">Average Rating: {selectedSupplier.averageRating > 0 ? selectedSupplier.averageRating.toFixed(1) : 'N/A'}</p>
                        {selectedSupplier.ratings && selectedSupplier.ratings.length > 0 && (
                            <div className="space-y-2 mt-2">
                                <p className="font-medium text-sm">All Ratings ({selectedSupplier.ratings.length}):</p>
                                {selectedSupplier.ratings.map((rating, index) => (
                                    <div key={index} className="bg-gray-50 p-3 rounded-md border border-gray-200">
                                        <div className="flex items-center text-sm font-semibold text-gray-800">
                                            Score: {rating.score} <Star size={14} className="ml-1 text-yellow-500 fill-current" />
                                            <span className="ml-auto text-xs text-gray-500">By {rating.byUser.substring(0, 8)}... on {new Date(rating.date.seconds * 1000).toLocaleDateString()}</span>
                                        </div>
                                        {rating.comment && <p className="text-xs text-gray-600 mt-1">"{rating.comment}"</p>}
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>

                    {/* Display and Verify Specific Documents */}
                    <div className="mt-4">
                        <p className="font-semibold">Required Documents:</p>
                        <ul className="divide-y divide-gray-200 rounded-md border border-gray-200">
                            {Object.keys(labelMap).map((docField, index) => {
                                const doc = selectedSupplier[docField];
                                if (docField === 'msmeDocument' && !selectedSupplier.isMsmeRegistered) {
                                    return null; // Don't show MSME doc if not registered
                                }
                                return (
                                    <li key={docField} className="flex items-center justify-between py-3 pl-3 pr-4 text-sm">
                                        <div className="flex w-0 flex-1 items-center">
                                            {doc ? (
                                                doc.verified ? (
                                                    <CheckCircle className="h-5 w-5 text-green-500 mr-2" />
                                                ) : (
                                                    <XCircle className="h-5 w-5 text-red-500 mr-2" />
                                                )
                                            ) : (
                                                <XCircle className="h-5 w-5 text-gray-400 mr-2" />
                                            )}
                                            <span className="ml-2 w-0 flex-1 truncate">{labelMap[docField]}: {doc ? doc.originalname : 'Not Uploaded'}</span>
                                            {doc && (
                                                <span className={`ml-2 text-xs font-medium ${doc.verified ? 'text-green-600' : 'text-red-600'}`}>
                                                    ({doc.verified ? 'Verified' : 'Not Verified'})
                                                </span>
                                            )}
                                        </div>
                                        {doc && (
                                            <div className="ml-4 flex-shrink-0">
                                                <button
                                                    type="button"
                                                    onClick={() => handleDocumentVerificationToggle(selectedSupplier.id, docField, doc.verified)}
                                                    className={`font-medium px-3 py-1 rounded-md text-white text-xs
                                                        ${doc.verified ? 'bg-orange-500 hover:bg-orange-600' : 'bg-green-500 hover:bg-green-600'}`}
                                                >
                                                    {doc.verified ? 'Mark Not Verified' : 'Mark Verified'}
                                                </button>
                                            </div>
                                        )}
                                    </li>
                                );
                            })}
                        </ul>
                    </div>
                  </div>
                )}
              </Modal>

              {/* Edit Supplier Modal */}
              <Modal isOpen={isEditModalOpen} onClose={() => setIsEditModalOpen(false)} title="Edit Supplier Details">
                {isSaving ? (
                  <LoadingSpinner message="Saving changes..." />
                ) : (
                  selectedSupplier && (
                    <div className="space-y-4 max-h-96 overflow-y-auto pr-2">
                      {/* Basic Info */}
                      <div>
                        <label htmlFor="editCompanyName" className="block text-sm font-medium text-gray-700">Company Name</label>
                        <input type="text" id="editCompanyName" name="companyName" value={editFormData.companyName || ''} onChange={handleEditChange}
                          className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" />
                      </div>
                      <div>
                        <label htmlFor="editContactPerson" className="block text-sm font-medium text-gray-700">Contact Person</label>
                        <input type="text" id="editContactPerson" name="contactPerson" value={editFormData.contactPerson || ''} onChange={handleEditChange}
                          className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" />
                      </div>
                      <div>
                        <label htmlFor="editEmail" className="block text-sm font-medium text-gray-700">Email</label>
                        <input type="email" id="editEmail" name="email" value={editFormData.email || ''} onChange={handleEditChange}
                          className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:focus:border-blue-500" />
                      </div>
                      <div>
                        <label htmlFor="editPhone" className="block text-sm font-medium text-gray-700">Phone</label>
                        <input type="tel" id="editPhone" name="phone" value={editFormData.phone || ''} onChange={handleEditChange}
                          className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" />
                      </div>

                      {/* MSME Registration Section in Edit */}
                      <div className="md:col-span-2">
                        <label className="block text-sm font-medium text-gray-700">MSME Registered?</label>
                        <div className="mt-2 flex space-x-4">
                          <label className="inline-flex items-center">
                            <input type="radio" name="isMsmeRegistered" value="true" checked={editFormData.isMsmeRegistered === true} onChange={handleEditChange}
                              className="form-radio text-blue-600 h-4 w-4" />
                            <span className="ml-2 text-gray-700">Yes</span>
                          </label>
                          <label className="inline-flex items-center">
                            <input type="radio" name="isMsmeRegistered" value="false" checked={editFormData.isMsmeRegistered === false} onChange={handleEditChange}
                              className="form-radio text-blue-600 h-4 w-4" />
                            <span className="ml-2 text-gray-700">No</span>
                          </label>
                        </div>
                      </div>

                      {/* MSME Document in Edit (conditional) */}
                      {editFormData.isMsmeRegistered === true && (
                          <div className="md:col-span-2">
                              <label className="block text-sm font-medium text-gray-700 mb-2">MSME Document</label>
                              <div className="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-md">
                                  <div className="space-y-1 text-center">
                                      <UploadCloud className="mx-auto h-12 w-12 text-gray-400" />
                                      <div className="flex text-sm text-gray-600">
                                          <label htmlFor="edit-msme-document" className="relative cursor-pointer bg-white rounded-md font-medium text-blue-600 hover:text-blue-500 focus-within:outline-none focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-blue-500">
                                              <span>Upload new MSME file</span>
                                              <input id="edit-msme-document" name="msmeDocument" type="file" className="sr-only" onChange={handleEditChange} accept=".pdf,.png,.jpg,.jpeg" />
                                          </label>
                                          <p className="pl-1">or drag and drop</p>
                                      </div>
                                      <p className="text-xs text-gray-500">PDF, PNG, JPG up to 10MB</p>
                                  </div>
                              </div>
                              {editFormData.msmeDocument && (
                                  <div className="mt-4">
                                      <ul className="divide-y divide-gray-200 rounded-md border border-gray-200">
                                          <li key="edit-msme-doc" className="flex items-center justify-between py-3 pl-3 pr-4 text-sm">
                                              <div className="flex w-0 flex-1 items-center">
                                                  {editFormData.msmeDocument instanceof File ? (
                                                      <CheckCircle className="h-5 w-5 text-green-500" aria-hidden="true" />
                                                  ) : (
                                                      <Eye className="h-5 w-5 text-blue-500" aria-hidden="true" />
                                                  )}
                                                  <span className="ml-2 w-0 flex-1 truncate">
                                                      {editFormData.msmeDocument instanceof File ? editFormData.msmeDocument.name : editFormData.msmeDocument.originalname}
                                                  </span>
                                              </div>
                                              <div className="ml-4 flex-shrink-0">
                                                  <button
                                                      type="button"
                                                      onClick={() => setEditFormData(prev => ({ ...prev, msmeDocument: null }))}
                                                      className="font-medium text-red-600 hover:text-red-500"
                                                  >
                                                      Remove
                                                  </button>
                                              </div>
                                          </li>
                                      </ul>
                                  </div>
                              )}
                          </div>
                      )}


                      {/* Prior Business Relationship Section in Edit */}
                      <div className="md:col-span-2">
                        <label className="block text-sm font-medium text-gray-700">Prior Business Relationship with Together?</label>
                        <div className="mt-2 flex space-x-4">
                          <label className="inline-flex items-center">
                            <input type="radio" name="hasPriorRelationship" value="true" checked={editFormData.hasPriorRelationship === true} onChange={handleEditChange}
                              className="form-radio text-blue-600 h-4 w-4" />
                            <span className="ml-2 text-gray-700">Yes</span>
                          </label>
                          <label className="inline-flex items-center">
                            <input type="radio" name="hasPriorRelationship" value="false" checked={editFormData.hasPriorRelationship === false} onChange={handleEditChange}
                              className="form-radio text-blue-600 h-4 w-4" />
                            <span className="ml-2 text-gray-700">No</span>
                          </label>
                        </div>
                      </div>

                      {/* Suitable For in Edit */}
                      <div className="relative">
                        <label htmlFor="editSuitableFor" className="block text-sm font-medium text-gray-700">Suitable For</label>
                        <select id="editSuitableFor" name="suitableFor" value={editFormData.suitableFor || ''} onChange={handleEditChange}
                          className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                          <option value="">Select an option</option>
                          {suitableForOptions.map(option => (
                            <option key={option} value={option}>{option}</option>
                          ))}
                        </select>
                      </div>

                      {/* Service Category in Edit */}
                      <div className="relative">
                        <label htmlFor="editServiceCategory" className="block text-sm font-medium text-gray-700">Service Category</label>
                        <select id="editServiceCategory" name="serviceCategory" value={editFormData.serviceCategory || ''} onChange={handleEditChange}
                          className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                          <option value="">Select a category</option>
                          {Object.keys(serviceCategories).sort().map(category => (
                            <option key={category} value={category}>{category}</option>
                          ))}
                        </select>
                      </div>

                      {/* Service Subcategory in Edit (dynamic) */}
                      <div className="relative">
                        <label htmlFor="editServiceSubcategory" className="block text-sm font-medium text-gray-700">Service Subcategory</label>
                        <select id="editServiceSubcategory" name="serviceSubcategory" value={editFormData.serviceSubcategory || ''} onChange={handleEditChange}
                          className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                          disabled={!editFormData.serviceCategory}>
                          <option value="">Select a subcategory</option>
                          {(serviceCategories[editFormData.serviceCategory] || []).sort().map(sub => (
                            <option key={sub} value={sub}>{sub}</option>
                          ))}
                        </select>
                      </div>

                      {/* Years in Business in Edit */}
                      <div>
                        <label htmlFor="editYearsInBusiness" className="block text-sm font-medium text-gray-700">Years in Business</label>
                        <input type="number" id="editYearsInBusiness" name="yearsInBusiness" value={editFormData.yearsInBusiness || ''} onChange={handleEditChange} min="0"
                          className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" />
                      </div>

                      {/* References in Edit */}
                      <div className="md:col-span-2">
                        <label htmlFor="editReferences" className="block text-sm font-medium text-gray-700">Client References</label>
                        <textarea id="editReferences" name="references" value={editFormData.references || ''} onChange={handleEditChange} rows="3"
                          className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></textarea>
                      </div>


                      {/* Status Update */}
                      <div>
                        <label htmlFor="editStatus" className="block text-sm font-medium text-gray-700">Status</label>
                        <select id="editStatus" name="status" value={editFormData.status || 'Pending Review'} onChange={handleEditChange}
                          className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                          <option value="Pending Review">Pending Review</option>
                          <option value="Approved">Approved</option>
                          <option value="Rejected">Rejected</option>
                          <option value="Needs More Info">Needs More Info</option>
                        </select>
                      </div>

                      {/* Individual Document Uploads for Edit */}
                      <div className="md:col-span-2 mt-6">
                          <h4 className="text-md font-medium text-gray-800 mb-2">Update Documents</h4>
                          {Object.keys(labelMap).map((docField) => {
                              if (docField === 'msmeDocument' && !editFormData.isMsmeRegistered) {
                                  return null; // Don't show MSME doc upload if not registered
                              }
                              return (
                                  <div key={`edit-${docField}`} className="mb-4">
                                      <label className="block text-sm font-medium text-gray-700 mb-2">{labelMap[docField]}</label>
                                      <div className="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-md">
                                          <div className="space-y-1 text-center">
                                              <UploadCloud className="mx-auto h-12 w-12 text-gray-400" />
                                              <div className="flex text-sm text-gray-600">
                                                  <label htmlFor={`edit-${docField}-upload`} className="relative cursor-pointer bg-white rounded-md font-medium text-blue-600 hover:text-blue-500 focus-within:outline-none focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-blue-500">
                                                      <span>Upload new file</span>
                                                      <input id={`edit-${docField}-upload`} name={docField} type="file" className="sr-only" onChange={handleEditChange} accept=".pdf,.png,.jpg,.jpeg" />
                                                  </label>
                                                  <p className="pl-1">or drag and drop</p>
                                              </div>
                                              <p className="text-xs text-gray-500">PDF, PNG, JPG up to 10MB</p>
                                          </div>
                                      </div>
                                      {editFormData[docField] && (
                                          <div className="mt-4">
                                              <ul className="divide-y divide-gray-200 rounded-md border border-gray-200">
                                                  <li className="flex items-center justify-between py-3 pl-3 pr-4 text-sm">
                                                      <div className="flex w-0 flex-1 items-center">
                                                          {editFormData[docField] instanceof File ? (
                                                              <CheckCircle className="h-5 w-5 text-green-500" aria-hidden="true" />
                                                          ) : (
                                                              <Eye className="h-5 w-5 text-blue-500" aria-hidden="true" />
                                                          )}
                                                          <span className="ml-2 w-0 flex-1 truncate">
                                                              {editFormData[docField] instanceof File ? editFormData[docField].name : editFormData[docField].originalname}
                                                          </span>
                                                      </div>
                                                      <div className="ml-4 flex-shrink-0">
                                                          <button
                                                              type="button"
                                                              onClick={() => setEditFormData(prev => ({ ...prev, [docField]: null }))}
                                                              className="font-medium text-red-600 hover:text-red-500"
                                                          >
                                                              Remove
                                                          </button>
                                                      </div>
                                                  </li>
                                              </ul>
                                          </div>
                                      )}
                                  </div>
                              );
                          })}
                      </div>


                      {/* Save Button */}
                      <div className="flex justify-end mt-6">
                        <button
                          onClick={handleSaveEdit}
                          className="px-6 py-3 bg-blue-600 text-white rounded-lg shadow-md hover:bg-blue-700 transition-colors duration-200 font-semibold"
                          disabled={isSaving}
                        >
                          {isSaving ? <LoadingSpinner message="" /> : 'Save Changes'}
                        </button>
                      </div>
                    </div>
                  )
                )}
              </Modal>

              {/* Confirm Delete Modal */}
              <Modal isOpen={isConfirmDeleteModalOpen} onClose={() => setIsConfirmDeleteModalOpen(false)} title="Confirm Deletion" type="error">
                {isSaving ? (
                  <LoadingSpinner message="Deleting supplier..." />
                ) : (
                  <>
                    <p>Are you sure you want to delete supplier "{supplierToDelete?.companyName}"?</p>
                    <p className="text-sm text-gray-500 mt-2">This action cannot be undone.</p>
                    <div className="flex justify-end space-x-3 mt-6">
                      <button
                        onClick={() => setIsConfirmDeleteModalOpen(false)}
                        className="px-4 py-2 rounded-md border border-gray-300 text-gray-700 hover:bg-gray-100 transition-colors duration-200"
                      >
                        Cancel
                      </button>
                      <button
                        onClick={handleDelete}
                        className="px-4 py-2 rounded-md bg-red-600 text-white hover:bg-red-700 transition-colors duration-200"
                      >
                        Delete
                      </button>
                    </div>
                  </>
                )}
              </Modal>

              {/* Rate Supplier Modal */}
              <Modal isOpen={isRateModalOpen} onClose={() => setIsRateModalOpen(false)} title={`Rate ${selectedSupplier?.companyName || 'Supplier'}`} type="info">
                {isSaving ? (
                  <LoadingSpinner message="Submitting rating..." />
                ) : (
                  <div className="space-y-4">
                    <p className="text-sm text-gray-600">Your User ID: {userId || 'N/A'}</p>
                    <div>
                      <label className="block text-sm font-medium text-gray-700">Rating (1-5 Stars)</label>
                      <div className="flex items-center mt-1">
                        {[1, 2, 3, 4, 5].map((star) => (
                          <Star
                            key={star}
                            size={28}
                            className={`cursor-pointer ${star <= ratingInput ? 'text-yellow-500 fill-current' : 'text-gray-300'}`}
                            onClick={() => setRatingInput(star)}
                          />
                        ))}
                      </div>
                      {ratingInput === 0 && <p className="text-red-500 text-xs mt-1">Please select a star rating.</p>}
                    </div>
                    <div>
                      <label htmlFor="ratingComment" className="block text-sm font-medium text-gray-700">Comment (Optional)</label>
                      <textarea
                        id="ratingComment"
                        value={ratingComment}
                        onChange={(e) => setRatingComment(e.target.value)}
                        rows="3"
                        className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                      ></textarea>
                    </div>
                    <div className="flex justify-end space-x-3 mt-6">
                      <button
                        onClick={() => setIsRateModalOpen(false)}
                        className="px-4 py-2 rounded-md border border-gray-300 text-gray-700 hover:bg-gray-100 transition-colors duration-200"
                      >
                        Cancel
                      </button>
                      <button
                        onClick={submitRating}
                        className="px-4 py-2 rounded-md bg-blue-600 text-white hover:bg-blue-700 transition-colors duration-200"
                        disabled={ratingInput === 0 || isSaving}
                      >
                        Submit Rating
                      </button>
                    </div>
                  </div>
                )}
              </Modal>
            </div>
          );
        };

        // Main App Component
        function App() {
          const [showDashboard, setShowDashboard] = useState(false);

          return (
            <AuthProvider>
              <div className="min-h-screen bg-gradient-to-br from-red-100 to-white font-inter">
                <header className="bg-white shadow-sm py-4 px-6 flex flex-col sm:flex-row justify-between items-center">
                  <h1 className="text-2xl font-bold text-blue-700 mb-4 sm:mb-0">Together Events</h1>
                  <nav className="flex flex-wrap justify-center sm:justify-end gap-2">
                    <button
                      onClick={() => setShowDashboard(false)}
                      className={`px-4 py-2 rounded-md text-sm font-medium transition-colors duration-200 ${!showDashboard ? 'bg-blue-600 text-white shadow-md' : 'text-gray-700 hover:bg-gray-100'}`}
                    >
                      Supplier Onboarding
                    </button>
                    <button
                      onClick={() => setShowDashboard(true)}
                      className={`px-4 py-2 rounded-md text-sm font-medium transition-colors duration-200 ${showDashboard ? 'bg-blue-600 text-white shadow-md' : 'text-gray-700 hover:bg-gray-100'}`}
                    >
                      Internal Dashboard
                    </button>
                  </nav>
                </header>

                <main className="p-4 sm:p-6">
                  {showDashboard ? (
                    <SupplierDashboard />
                  ) : (
                    <SupplierOnboardingForm onSubmitSuccess={() => setShowDashboard(true)} />
                  )}
                </main>

                <footer className="bg-gray-800 text-white text-center py-4 mt-10">
                  <p>&copy; {new Date().getFullYear()} Together Events Private Limited. All rights reserved.</p>
                </footer>
              </div>
            </AuthProvider>
          );
        }

        // --- React App Mounting ---
        // Changed from DOMContentLoaded to window.onload to ensure all external scripts (like Firebase) are fully loaded.
        window.addEventListener('load', function() {
            const rootElement = document.getElementById('root');
            if (rootElement) {
                const root = ReactDOM.createRoot(rootElement);
                root.render(<App />);
            } else {
                console.error("Root element not found!");
            }
        });

        // --- React App Code Ends Here ---
    </script>
</body>
</html>
